<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Tree - by lovenn</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0b1a2a 0%, #000000 100%);
            font-family: 'Times New Roman', serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }

        .loader-text {
            color: #aaddff;
            font-size: 14px;
            letter-spacing: 4px;
            margin-top: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid #00ffcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* æ ‡é¢˜ */
        h1 {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            margin: 0;
            pointer-events: none;
            font-size: 36px;
            font-weight: 400;
            background: linear-gradient(135deg, #e0f7fa 0%, #ffffff 50%, #88ccff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: aurora-shine 6s linear infinite;
            opacity: 0.9;
        }

        @keyframes aurora-shine {
            0% {
                background-position: 0% center;
            }

            100% {
                background-position: 300% center;
            }
        }

        /* ä¸Šä¼ æŒ‰é’® */
        .upload-wrapper {
            position: absolute;
            top: 40px;
            right: 40px;
            z-index: 20;
            pointer-events: auto;
            display: flex;
            gap: 10px;
        }

        .upload-btn,
        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 8px 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover,
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ffcc;
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }

        .control-btn.active {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        #file-input,
        #import-input {
            display: none;
        }

        /* æ‘„åƒå¤´é¢„è§ˆçª—å£ */
        #webcam-wrapper {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            opacity: 0.8;
            z-index: 20;
            background: #000;
        }

        #webcam-wrapper canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* æ“ä½œæç¤º */
        #tips {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            backdrop-filter: blur(10px);
            z-index: 15;
        }

        .tip-item {
            margin: 6px 0;
        }

        .tip-key {
            color: #00ffcc;
            display: inline-block;
            min-width: 60px;
        }

        /* ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            margin-left: auto;
            margin-right: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: #fff;
            font-size: 18px;
            font-weight: 400;
        }

        .modal-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .photo-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .photo-item:hover {
            border-color: #00ffcc;
            transform: translateY(-2px);
        }

        .photo-item.in-scene {
            border-color: #00ffcc;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .photo-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 8px;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }

        .photo-size {
            margin-bottom: 4px;
        }

        .photo-status {
            color: #00ffcc;
            font-size: 9px;
        }

        .photo-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .photo-action-btn {
            flex: 1;
            padding: 6px 4px;
            font-size: 9px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .photo-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .photo-action-btn.add-scene {
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .photo-action-btn.add-scene:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .photo-action-btn.remove-scene {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .photo-action-btn.delete {
            border-color: #ff4444;
            color: #ff4444;
        }

        .photo-action-btn.delete:hover {
            background: rgba(255, 68, 68, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
        }

        .modal-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 14px;
            font-size: 11px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .modal-action-btn.upload {
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .modal-action-btn.upload:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .modal-action-btn.import {
            border-color: #88aaff;
            color: #88aaff;
        }

        .modal-action-btn.import:hover {
            background: rgba(136, 170, 255, 0.1);
        }

        .modal-action-btn.export {
            border-color: #ffaa00;
            color: #ffaa00;
        }

        .modal-action-btn.export:hover {
            background: rgba(255, 170, 0, 0.1);
        }

        .cache-stats {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .cache-stats .highlight {
            color: #00ffcc;
        }

        .cache-stats .warning {
            color: #ffaa00;
        }

        .clear-all-btn {
            padding: 8px 16px;
            font-size: 11px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .clear-all-btn:hover {
            background: rgba(255, 68, 68, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª—æ ·å¼ */
        #camera-permission-modal {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 10000;
            display: none;
        }

        #camera-permission-modal.show {
            display: block;
        }

        #camera-permission-modal .modal-content {
            max-width: 260px;
            background: rgba(10, 20, 30, 0.95);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #camera-permission-modal .modal-header {
            border-bottom: none;
            padding: 0 0 10px 0;
        }

        #camera-permission-modal .modal-header h2 {
            font-size: 14px;
            color: #00ffcc;
            margin: 0;
        }

        #camera-permission-modal .modal-body {
            padding: 0;
        }

        #camera-permission-modal .modal-body p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin: 5px 0;
        }

        #camera-permission-modal .modal-footer {
            display: flex;
            gap: 10px;
            padding: 12px 0 0 0;
            border-top: none;
        }

        #camera-permission-modal .modal-action-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
        }

        /* å¯¼å‡ºå‘½åå¯¹è¯æ¡†æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ffcc;
        }

        .form-group input[readonly] {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .filename-preview {
            padding: 10px;
            background: rgba(0, 255, 204, 0.1);
            border-radius: 6px;
            color: #00ffcc;
            font-size: 12px;
            word-break: break-all;
        }

        /* éŸ³ä¹ç®¡ç†æ ·å¼ */
        .music-source-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .music-tab {
            flex: 1;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .music-tab.active {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .music-tab-content {
            padding: 15px 0;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #00ffcc;
            background: rgba(0, 255, 204, 0.05);
        }

        .upload-area.dragover {
            border-color: #00ffcc;
            background: rgba(0, 255, 204, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
        }

        .current-music-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .music-info-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
            margin-bottom: 5px;
        }

        .music-info-value {
            color: #00ffcc;
            font-size: 13px;
            word-break: break-all;
        }

        .music-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .music-control-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .music-control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .music-control-btn.playing {
            background: rgba(0, 255, 204, 0.1);
            border-color: #00ffcc;
            color: #00ffcc;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }

        .volume-label {
            font-size: 16px;
        }

        .volume-value {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            min-width: 35px;
        }

        #music-volume {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
        }

        #music-volume::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #00ffcc;
            border-radius: 50%;
            cursor: pointer;
        }

        #music-volume::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #00ffcc;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media screen and (max-width: 768px) {

            /* æ ‡é¢˜ç¼©å° */
            h1 {
                font-size: 20px;
                top: 15px;
            }

            /* æ§åˆ¶æŒ‰é’®ä½ç½®è°ƒæ•´ */
            .upload-wrapper {
                top: 15px;
                right: 15px;
                gap: 8px;
            }

            .control-btn {
                padding: 6px 12px;
                font-size: 9px;
            }

            /* éšè—æ§åˆ¶æŒ‰é’®ï¼ˆç®¡ç†ã€éŸ³ä¹ï¼‰å’Œé”®ç›˜æç¤ºé¢æ¿ */
            .upload-wrapper,
            #tips {
                display: none !important;
            }

            /* æ¨¡æ€æ¡†ä¼˜åŒ– */
            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: 15px;
                flex-wrap: wrap;
            }

            .modal-header h2 {
                font-size: 16px;
            }

            .header-actions {
                margin-left: 0;
                margin-right: 0;
                width: 100%;
                margin-top: 10px;
                justify-content: flex-start;
            }

            .modal-close {
                font-size: 28px;
                padding: 8px;
                min-width: 44px;
                min-height: 44px;
            }

            .modal-body {
                padding: 15px;
                -webkit-overflow-scrolling: touch;
            }

            /* ç…§ç‰‡ç½‘æ ¼æ›´ç´§å‡‘ */
            .photo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .photo-action-btn {
                padding: 10px 6px;
                font-size: 10px;
            }

            .modal-footer {
                padding: 12px 15px;
                flex-direction: column;
                gap: 10px;
            }

            .cache-stats {
                font-size: 11px;
                text-align: center;
            }

            /* æ‘„åƒå¤´é¢„è§ˆç¼©å° */
            #webcam-wrapper {
                width: 100px;
                height: 75px;
                bottom: 5px;
                right: 5px;
            }

            /* éŸ³ä¹æ§åˆ¶ä¼˜åŒ– */
            .music-controls {
                flex-direction: column;
                gap: 10px;
            }

            .music-control-btn {
                width: 100%;
                padding: 12px;
            }

            .volume-control {
                width: 100%;
            }

            .music-source-tabs {
                flex-direction: column;
            }

            .music-tab {
                width: 100%;
            }

            /* å¯¼å‡ºå¯¹è¯æ¡†ä¼˜åŒ– */
            #export-name-modal .modal-content {
                max-width: 95%;
            }

            /* æ‘„åƒå¤´æƒé™å¼¹çª—ä¼˜åŒ– */
            #camera-permission-modal {
                top: 10px;
                left: 10px;
                right: 10px;
            }

            #camera-permission-modal .modal-content {
                max-width: 100%;
            }

            .modal-action-btn {
                padding: 10px 14px;
                font-size: 12px;
                min-height: 44px;
            }
        }

        /* ========== å‘Šç™½ä¹¦ä¿¡æ ·å¼ ========== */

        /* ä¹¦ä¿¡æ¨¡æ€æ¡† */
        #letter-modal .modal-content {
            max-width: 500px;
        }

        .letter-preview-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .letter-preview-title {
            color: #ffaa00;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .letter-preview-content {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            line-height: 1.6;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: pre-wrap;
        }

        .letter-preview-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .letter-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .letter-upload-area:hover {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.05);
        }

        .letter-upload-area.dragover {
            border-color: #ff6b9d;
            background: rgba(255, 107, 157, 0.1);
        }

        .letter-upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .letter-upload-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            margin-bottom: 5px;
        }

        .letter-upload-hint {
            color: rgba(255, 255, 255, 0.4);
            font-size: 11px;
        }

        .letter-music-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 10px;
        }

        .letter-music-title {
            color: #ff6b9d;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .letter-music-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .letter-music-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .letter-music-option input[type="radio"] {
            accent-color: #ff6b9d;
        }

        .letter-music-option label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            cursor: pointer;
        }

        .letter-custom-music {
            margin-top: 10px;
            padding-left: 24px;
        }

        .letter-custom-music-upload {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .letter-custom-music-name {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .empty-letter-state {
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        /* ä¿¡å°é£å‡ºåŠ¨ç”»å®¹å™¨ */
        #envelope-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            pointer-events: none;
            display: none;
        }

        #envelope-container.show {
            display: block;
            pointer-events: auto;
        }

        /* ä¿¡å°æ ·å¼ */
        .envelope {
            position: absolute;
            width: 120px;
            height: 80px;
            cursor: pointer;
            transform-style: preserve-3d;
            animation: envelopeFloat 3s ease-in-out infinite;
        }

        .envelope-body {
            display: none;  /* éšè—ä¿¡å°ä¸»ä½“ */
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe4e4 100%);
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(255, 107, 157, 0.4), 0 0 20px rgba(255, 107, 157, 0.2);
        }

        .envelope-flap {
            display: none;  /* éšè—ä¿¡å°ç›–å­ */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(180deg, #ffccd5 0%, #fff5f5 100%);
            clip-path: polygon(0 0, 50% 100%, 100% 0);
            transform-origin: top center;
            transition: transform 0.5s ease;
        }

        .envelope-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;  /* æ”¹æˆå¤§å›¾æ ‡ */
            filter: drop-shadow(0 0 15px rgba(255, 105, 180, 0.8));  /* å‘å…‰æ•ˆæœ */
            animation: heartBeat 1s ease-in-out infinite;  /* å¿ƒè·³åŠ¨ç”» */
        }

        /* å¿ƒè·³åŠ¨ç”» */
        @keyframes heartBeat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.15); }
        }

        /* ä¿¡å°æ‚¬åœæ•ˆæœå·²ç§»é™¤ï¼Œå› ä¸ºæ”¹ç”¨æ¯”å¿ƒå›¾æ ‡ */

        @keyframes envelopeFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes envelopeFlyIn {
            0% {
                opacity: 0;
                transform: translate(0, 0) scale(0.3) rotate(-20deg);
            }

            50% {
                opacity: 1;
                transform: translate(calc(50vw - 60px), calc(50vh - 40px)) scale(0.8) rotate(10deg);
            }

            100% {
                opacity: 1;
                transform: translate(calc(50vw - 60px), calc(50vh - 40px)) scale(1) rotate(0deg);
            }
        }

        /* æ¯”å¿ƒç‰¹æ•ˆ */
        .heart-particle {
            position: fixed;
            font-size: 20px;
            pointer-events: none;
            z-index: 600;
            animation: heartFloat 1.5s ease-out forwards;
        }

        @keyframes heartFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        /* ä¹¦ä¿¡å±•ç¤ºå…¨å± */
        #letter-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0);
            transition: background 0.5s ease;
        }

        #letter-display.show {
            display: flex;
            background: rgba(0, 0, 0, 0.85);
        }

        /* å¤å¤ä¿¡çº¸ */
        .letter-paper {
            position: relative;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            background: linear-gradient(to bottom,
                    #fef9e7 0%,
                    #fdf6e3 50%,
                    #f5ecd3 100%);
            border-radius: 4px;
            padding: 40px 50px;
            box-shadow:
                0 0 0 1px rgba(139, 90, 43, 0.1),
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 0 80px rgba(139, 90, 43, 0.05);
            transform: scale(0.8) rotateX(10deg);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow-y: auto;
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        #letter-display.show .letter-paper {
            transform: scale(1) rotateX(0deg);
            opacity: 1;
        }

        /* ä¿¡çº¸è£…é¥° */
        .letter-paper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(transparent,
                    transparent 27px,
                    rgba(139, 90, 43, 0.1) 28px);
            pointer-events: none;
        }

        .letter-paper::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid rgba(139, 90, 43, 0.15);
            border-radius: 2px;
            pointer-events: none;
        }

        .letter-paper-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px dashed rgba(139, 90, 43, 0.2);
        }

        .letter-paper-title {
            color: #8b4513;
            font-size: 24px;
            font-weight: normal;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(139, 90, 43, 0.1);
        }

        .letter-paper-date {
            color: rgba(139, 90, 43, 0.6);
            font-size: 12px;
            margin-top: 8px;
        }

        .letter-paper-content {
            color: #5d4037;
            font-size: 16px;
            line-height: 2;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            z-index: 1;
        }

        .letter-paper-content .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background: #8b4513;
            margin-left: 2px;
            animation: cursorBlink 0.8s infinite;
        }

        @keyframes cursorBlink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .letter-paper-footer {
            text-align: right;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed rgba(139, 90, 43, 0.2);
            color: #8b4513;
            font-style: italic;
        }

        .letter-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(139, 90, 43, 0.1);
            border: 1px solid rgba(139, 90, 43, 0.2);
            border-radius: 50%;
            color: #8b4513;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .letter-close-btn:hover {
            background: rgba(139, 90, 43, 0.2);
        }

        /* æ‰‹åŠ¿åé¦ˆ */
        .gesture-feedback {
            position: fixed;
            bottom: 140px;
            right: 20px;
            background: rgba(255, 107, 157, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .gesture-feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .letter-paper {
                padding: 30px 25px;
                max-width: 95%;
            }

            .letter-paper-title {
                font-size: 20px;
            }

            .letter-paper-content {
                font-size: 14px;
            }

            .envelope {
                width: 100px;
                height: 66px;
            }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://testingcf.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://testingcf.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://testingcf.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
</head>

<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loader-text">Loading...</div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <h1>Merry Christmas</h1>
        <div class="upload-wrapper">
            <button class="control-btn" id="manage-btn" title="ç®¡ç†ç¼“å­˜ç…§ç‰‡">ğŸ“ ç®¡ç†</button>
            <button class="control-btn" id="music-btn" title="æ’­æ”¾/æš‚åœéŸ³ä¹">ğŸµ éŸ³ä¹</button>
            <button class="control-btn" id="letter-btn" title="å‘Šç™½ä¹¦ä¿¡">ğŸ’Œ ä¹¦ä¿¡</button>
        </div>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bg-music" loop autoplay>
        <source src="music.mp3?v=2" type="audio/mpeg">
    </audio>

    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline style="display:none;"></video>
        <canvas id="webcam-preview"></canvas>
    </div>

    <!-- ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="cache-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç…§ç‰‡ç¼“å­˜ç®¡ç†</h2>
                <div class="header-actions">
                    <label class="modal-action-btn upload">
                        ğŸ“· ä¸Šä¼ ç…§ç‰‡
                        <input type="file" id="file-input" multiple accept="image/*" style="display:none;">
                    </label>
                    <label class="modal-action-btn import">
                        ğŸ“¥ å¯¼å…¥
                        <input type="file" id="import-input" accept=".json" style="display:none;">
                    </label>
                    <button class="modal-action-btn export" id="export-btn">ğŸ“¤ å¯¼å‡º</button>
                </div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="photo-grid" class="photo-grid"></div>
            </div>
            <div class="modal-footer">
                <div class="cache-stats" id="cache-stats">
                    å·²ç¼“å­˜ <span class="highlight">0</span> å¼ ç…§ç‰‡ (<span class="highlight">0 KB</span> / 50 MB)
                </div>
                <button class="clear-all-btn" id="clear-all-btn">æ¸…ç©ºå…¨éƒ¨</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºå‘½åå¯¹è¯æ¡† -->
    <div id="export-name-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>å¯¼å‡ºç…§ç‰‡</h2>
                <button class="modal-close" id="export-name-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ä¸»é¢˜å</label>
                    <input type="text" id="export-theme" value="Merry Christmas">
                </div>
                <div class="form-group">
                    <label>è‡ªå®šä¹‰åç§°</label>
                    <input type="text" id="export-custom" placeholder="ä¾‹ï¼šå¥³æœ‹å‹é“ç…§åˆé›†">
                </div>
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="text" id="export-date" readonly>
                </div>
                <div class="filename-preview">
                    é¢„è§ˆ: <span id="filename-preview"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="export-cancel">å–æ¶ˆ</button>
                <button class="modal-action-btn export" id="export-confirm">ç¡®è®¤å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- éŸ³ä¹ç®¡ç†å¯¹è¯æ¡† -->
    <div id="music-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>ğŸµ éŸ³ä¹ç®¡ç†</h2>
                <button class="modal-close" id="music-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="music-source-tabs">
                    <button class="music-tab active" data-tab="url">ğŸ”— éŸ³ä¹é“¾æ¥</button>
                    <button class="music-tab" data-tab="upload">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
                </div>

                <div class="music-tab-content" id="tab-url">
                    <div class="form-group">
                        <label>è¾“å…¥éŸ³ä¹é“¾æ¥ (æ”¯æŒ MP3, WAV, OGG ç­‰æ ¼å¼)</label>
                        <input type="text" id="music-url-input" placeholder="https://example.com/music.mp3">
                    </div>
                    <button class="modal-action-btn upload" id="apply-url-btn" style="width: 100%;">åº”ç”¨é“¾æ¥</button>
                </div>

                <div class="music-tab-content" id="tab-upload" style="display: none;">
                    <div class="form-group">
                        <label>é€‰æ‹©æœ¬åœ°éŸ³é¢‘æ–‡ä»¶</label>
                        <div class="upload-area" id="music-upload-area">
                            <div class="upload-icon">ğŸµ</div>
                            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½éŸ³é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                            <div class="upload-hint">æ”¯æŒ MP3, WAV, OGG, M4A æ ¼å¼</div>
                            <input type="file" id="music-file-input" accept="audio/*" style="display: none;">
                        </div>
                    </div>
                </div>

                <div class="current-music-info" id="current-music-info">
                    <div class="music-info-label">å½“å‰éŸ³ä¹:</div>
                    <div class="music-info-value" id="current-music-name">é»˜è®¤éŸ³ä¹</div>
                </div>

                <div class="music-controls">
                    <button class="music-control-btn" id="music-play-btn">â–¶ æ’­æ”¾</button>
                    <button class="music-control-btn" id="music-pause-btn">â¸ æš‚åœ</button>
                    <div class="volume-control">
                        <span class="volume-label">ğŸ”Š</span>
                        <input type="range" id="music-volume" min="0" max="100" value="50">
                        <span class="volume-value" id="volume-value">50%</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="music-reset-btn">ğŸ”„ æ¢å¤é»˜è®¤</button>
                <button class="modal-action-btn export" id="music-close-btn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª— -->
    <div id="camera-permission-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å¼€å¯æ‘„åƒå¤´ï¼Ÿ</h2>
            </div>
            <div class="modal-body">
                <p>å¼€å¯åå¯ç”¨æ‰‹åŠ¿æ§åˆ¶åœºæ™¯</p>
                <p>ä¸å¼€å¯åˆ™ç”¨é”®ç›˜æ§åˆ¶</p>
            </div>
            <div class="modal-footer">
                <button class="modal-action-btn" id="camera-deny-btn">è·³è¿‡</button>
                <button class="modal-action-btn upload" id="camera-allow-btn">å¼€å¯</button>
            </div>
        </div>
    </div>

    <!-- ä¹¦ä¿¡ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="letter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ’Œ å‘Šç™½ä¹¦ä¿¡</h2>
                <button class="modal-close" id="letter-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- å½“å‰ä¹¦ä¿¡é¢„è§ˆ -->
                <div id="letter-preview-section" style="display: none;">
                    <div class="letter-preview-box">
                        <div class="letter-preview-title">ğŸ“„ å½“å‰ä¹¦ä¿¡</div>
                        <div class="letter-preview-content" id="letter-preview-text"></div>
                        <div class="letter-preview-actions">
                            <button class="modal-action-btn" id="preview-letter-btn">ğŸ‘ é¢„è§ˆ</button>
                            <button class="modal-action-btn" id="delete-letter-btn"
                                style="border-color: #ff4444; color: #ff4444;">ğŸ—‘ åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div id="letter-upload-section">
                    <div class="letter-upload-area" id="letter-upload-area">
                        <div class="letter-upload-icon">ğŸ’Œ</div>
                        <div class="letter-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ txt æ–‡ä»¶åˆ°è¿™é‡Œ</div>
                        <div class="letter-upload-hint">ä¸Šä¼ æ‚¨çš„å‘Šç™½ä¹¦ä¿¡</div>
                        <input type="file" id="letter-file-input" accept=".txt" style="display: none;">
                    </div>
                </div>

                <!-- æµªæ¼«éŸ³ä¹è®¾ç½® -->
                <div class="letter-music-section">
                    <div class="letter-music-title">ğŸµ æµªæ¼«éŸ³ä¹è®¾ç½®</div>
                    <div class="letter-music-options">
                        <div class="letter-music-option">
                            <input type="radio" name="letter-music" id="music-default" value="default" checked>
                            <label for="music-default">ä½¿ç”¨é»˜è®¤æµªæ¼«éŸ³ä¹</label>
                        </div>
                        <div class="letter-music-option">
                            <input type="radio" name="letter-music" id="music-custom" value="custom">
                            <label for="music-custom">è‡ªå®šä¹‰éŸ³ä¹</label>
                        </div>
                        <div class="letter-custom-music" id="letter-custom-music" style="display: none;">
                            <div class="letter-custom-music-upload">
                                <button class="modal-action-btn upload" id="upload-custom-music-btn">ä¸Šä¼ éŸ³é¢‘</button>
                                <span class="letter-custom-music-name" id="custom-music-name">æœªé€‰æ‹©æ–‡ä»¶</span>
                                <input type="file" id="custom-music-input" accept="audio/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="cache-stats">
                    <span>ğŸ‘ ç‚¹èµæ‰‹åŠ¿è§¦å‘ä¹¦ä¿¡å±•ç¤º</span>
                </div>
                <button class="modal-action-btn export" id="letter-close-btn">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¿¡å°å®¹å™¨ -->
    <div id="envelope-container">
        <div class="envelope" id="envelope">
            <div class="envelope-body"></div>
            <div class="envelope-flap"></div>
            <div class="envelope-heart">â¤ï¸</div>
        </div>
    </div>

    <!-- ä¹¦ä¿¡å±•ç¤ºåŒºåŸŸ -->
    <div id="letter-display">
        <div class="letter-paper">
            <button class="letter-close-btn" id="letter-display-close">&times;</button>
            <div class="letter-paper-header">
                <h2 class="letter-paper-title" id="letter-title">è‡´æœ€çˆ±çš„ä½ </h2>
                <div class="letter-paper-date" id="letter-date"></div>
            </div>
            <div class="letter-paper-content" id="letter-content"></div>
            <div class="letter-paper-footer">
                â€”â€” æ°¸è¿œçˆ±ä½ çš„äºº
            </div>
        </div>
    </div>

    <!-- ç‚¹èµæ‰‹åŠ¿åé¦ˆ -->
    <div class="gesture-feedback" id="gesture-feedback">ğŸ‘ ç‚¹èµæ£€æµ‹ä¸­...</div>

    <!-- æµªæ¼«èƒŒæ™¯éŸ³ä¹ -->
    <audio id="romantic-music" loop>
        <source src="music.mp3?v=2" type="audio/mpeg">
    </audio>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // ========== é¢„è®¾éŸ³ä¹é…ç½®ï¼ˆå¯è‡ªå®šä¹‰ä¿®æ”¹ï¼‰ ==========
        const PRESET_MUSIC = {
            // èƒŒæ™¯éŸ³ä¹ï¼ˆåœ£è¯æ ‘åœºæ™¯é»˜è®¤æ’­æ”¾ï¼‰
            background: 'music.mp3',
            // æµªæ¼«éŸ³ä¹ï¼ˆä¹¦ä¿¡å±•ç¤ºæ—¶æ’­æ”¾ï¼‰
            romantic: 'music.mp3'
        };

        // å…¨å±€å˜é‡
        let scene, camera, renderer, composer, bloomPass, mainGroup;
        let clock = new THREE.Clock();
        let particleSystem = [], photoMeshGroup = new THREE.Group();
        let handLandmarker, video, webcamCanvas, webcamCtx;
        let snowSystem;
        let photoDataArray = []; // å­˜å‚¨æ‰€æœ‰ç…§ç‰‡çš„base64æ•°æ®
        let photoIdToMeshMap = new Map(); // ç…§ç‰‡IDåˆ°åœºæ™¯meshçš„æ˜ å°„

        // ========== é¢„ç½®ç…§ç‰‡æ•°æ® ==========
        // ä½¿ç”¨æ–¹æ³•ï¼šå°†å¯¼å‡ºçš„JSONæ–‡ä»¶ä¸­çš„ photos æ•°ç»„å†…å®¹ç²˜è´´åˆ°ä¸‹é¢çš„æ•°ç»„ä¸­
        // æ ¼å¼ç¤ºä¾‹ï¼š["data:image/jpeg;base64,/9j/4AAQ...", "data:image/png;base64,iVBORw0..."]
        const PRESET_PHOTOS = [
    "photo1.png",
    "photo2.png",
    "photo3.png",
    "photo4.png",
    "photo5.png",
    "photo6.png",
    "photo7.png"
]
        // ====================================

        // ç¼“å­˜é…ç½®
        const CACHE_CONFIG = {
            maxSizeMB: 50,
            warnAtPercent: 80, // è¾¾åˆ°80%æ—¶æç¤ºç”¨æˆ·
            dbName: 'ChristmasTreeDB',
            storeName: 'photos',
            // éŸ³ä¹ç¼“å­˜é…ç½®
            musicStoreName: 'music',
            maxMusicSizeMB: 20
        };

        // IndexedDB å·¥å…·å‡½æ•°
        const PhotoCache = {
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CACHE_CONFIG.dbName, 1);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(CACHE_CONFIG.storeName)) {
                            const store = db.createObjectStore(CACHE_CONFIG.storeName, { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            },

            async savePhoto(base64Data) {
                // æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´
                const newSize = this.getBase64Size(base64Data);

                if (navigator.storage && navigator.storage.estimate) {
                    try {
                        const estimate = await navigator.storage.estimate();
                        const usedPercent = (estimate.usage / estimate.quota) * 100;
                        const remainingSpace = estimate.quota - estimate.usage;

                        // æ¥è¿‘é™åˆ¶æ—¶æç¤ºç”¨æˆ·ï¼ˆ80%ï¼‰
                        if (usedPercent >= CACHE_CONFIG.warnAtPercent && usedPercent < 95) {
                            console.warn(`å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡: ${usedPercent.toFixed(1)}%ï¼Œå»ºè®®æ¸…ç†ä¸€äº›ç…§ç‰‡`);
                        }

                        // ç©ºé—´ä¸è¶³æ—¶é˜»æ­¢ä¸Šä¼ 
                        if (remainingSpace < newSize * 1.1) { // ç•™10%ä½™é‡
                            return { success: false, reason: 'size', message: 'æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·å…ˆåˆ é™¤ä¸€äº›ç…§ç‰‡æˆ–æ¸…ç†æµè§ˆå™¨ç¼“å­˜' };
                        }
                    } catch (e) {
                        console.warn('æ— æ³•æ£€æµ‹å­˜å‚¨ç©ºé—´:', e);
                    }
                }

                const photo = {
                    id: 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    base64: base64Data,
                    timestamp: Date.now(),
                    size: newSize,
                    inScene: true
                };

                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.add(photo);
                    request.onsuccess = () => resolve({ success: true, photo });
                    request.onerror = () => resolve({ success: false, reason: 'db', message: 'ä¿å­˜å¤±è´¥' });
                });
            },

            async getAllPhotos() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readonly');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                });
            },

            async deletePhoto(id) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async updatePhoto(photo) {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.put(photo);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async clearAll() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction(CACHE_CONFIG.storeName, 'readwrite');
                    const store = tx.objectStore(CACHE_CONFIG.storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => resolve(false);
                });
            },

            async getStats() {
                const photos = await this.getAllPhotos();
                const totalSize = photos.reduce((sum, p) => sum + (p.size || 0), 0);
                return {
                    count: photos.length,
                    totalSize,
                    inSceneCount: photos.filter(p => p.inScene).length
                };
            },

            getBase64Size(base64) {
                // è®¡ç®—base64å­—ç¬¦ä¸²çš„å®é™…å­—èŠ‚å¤§å°
                const base64Length = base64.length - (base64.indexOf(',') + 1);
                const padding = (base64.match(/=+$/) || [''])[0].length;
                return Math.floor((base64Length * 3) / 4) - padding;
            },

            formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        };

        // æè´¨å¯¹è±¡
        const MATERIALS = {};

        // çŠ¶æ€ç®¡ç†
        const STATE = {
            mode: 'TREE', // TREE, SCATTER, FOCUS
            hand: { detected: false, x: 0, y: 0 },
            rotation: { x: 0, y: 0 },
            camera: {
                targetPos: new THREE.Vector3(0, 2, 50),
                targetLookAt: new THREE.Vector3(0, 0, 0),
                currentLookAt: new THREE.Vector3(0, 0, 0)
            },
            focusTarget: null
        };

        // åˆå§‹åŒ– Three.js
        function initThree() {
            const container = document.getElementById('canvas-container');

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x111111, 0.02);

            camera = new THREE.PerspectiveCamera(42, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 50);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            renderer.toneMappingExposure = 2.2;
            container.appendChild(renderer.domElement);

            scene.environment = new THREE.PMREMGenerator(renderer).fromScene(new RoomEnvironment(), 0.04).texture;

            mainGroup = new THREE.Group();
            scene.add(mainGroup);
        }

        // åˆ›å»ºæè´¨
        function createMaterials() {
            MATERIALS.gold = new THREE.MeshStandardMaterial({
                color: 0xb8860b,  // æ·±é‡‘è‰²ï¼ˆæš—é‡‘ï¼‰
                metalness: 0.7,
                roughness: 0.3,
                envMapIntensity: 1.2,
                emissive: 0x3d2b0f,  // æš—é‡‘è‰²è‡ªå‘å…‰
                emissiveIntensity: 0.2
            });

            MATERIALS.green = new THREE.MeshStandardMaterial({
                color: 0x2d5016,  // æ·±ç»¿è‰²ï¼ˆæ¾æ ‘ç»¿ï¼‰
                metalness: 0.1,
                roughness: 0.9,
                emissive: 0x1a2e0d,  // æš—ç»¿è‰²è‡ªå‘å…‰
                emissiveIntensity: 0.15
            });

            MATERIALS.red = new THREE.MeshPhysicalMaterial({
                color: 0x8b2635,  // æ·±çº¢è‰²ï¼ˆé…’çº¢ï¼‰
                metalness: 0.2,
                roughness: 0.4,
                clearcoat: 0.6,
                emissive: 0x3d1419  // æš—çº¢è‰²è‡ªå‘å…‰
            });

            MATERIALS.frame = new THREE.MeshBasicMaterial({ color: 0xffffff });

            MATERIALS.star = new THREE.MeshStandardMaterial({
                color: 0xffd700,  // é‡‘è‰²æ˜Ÿæ˜Ÿ
                emissive: 0xffaa00,  // é‡‘è‰²è‡ªå‘å…‰
                emissiveIntensity: 0.8,
                metalness: 0.8,
                roughness: 0.2
            });

            // ç³–æœçº¹ç†ï¼ˆçº¢ç™½æ¡çº¹ï¼‰
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = '#c41e3a';  // åœ£è¯çº¢
            ctx.beginPath();
            for (let i = -128; i < 256; i += 32) {
                ctx.moveTo(i, 0);
                ctx.lineTo(i + 32, 128);
                ctx.lineTo(i + 16, 128);
                ctx.lineTo(i - 16, 0);
            }
            ctx.fill();
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(3, 3);
            MATERIALS.candy = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.4 });
        }

        // è®¾ç½®ç¯å…‰
        function setupLights() {
            scene.add(new THREE.AmbientLight(0xfff5e6, 0.5));  // æ¸©æš–çš„ç¯å¢ƒå…‰

            const innerLight = new THREE.PointLight(0xffd700, 1.5, 20);  // é‡‘è‰²å†…éƒ¨å…‰
            innerLight.position.set(0, 5, 0);
            mainGroup.add(innerLight);

            const spot1 = new THREE.SpotLight(0xffe4b5, 1200);  // æ¸©æš–çš„èšå…‰ç¯
            spot1.position.set(30, 40, 40);
            scene.add(spot1);

            const spot2 = new THREE.SpotLight(0xc41e3a, 600);  // åœ£è¯çº¢èšå…‰ç¯
            spot2.position.set(-30, 20, -30);
            scene.add(spot2);

            const fill = new THREE.DirectionalLight(0xffffff, 0.6);  // æŸ”å’Œçš„è¡¥å…‰
            fill.position.set(0, 0, 50);
            scene.add(fill);
        }

        // ç²’å­ç±»
        class Particle {
            constructor(mesh, type) {
                this.mesh = mesh;
                this.type = type;
                this.posTree = new THREE.Vector3();
                this.posScatter = new THREE.Vector3();
                this.baseScale = mesh.scale.x;
                this.spinSpeed = new THREE.Vector3(
                    Math.random() - 0.5,
                    Math.random() - 0.5,
                    Math.random() - 0.5
                ).multiplyScalar(type === 'PHOTO' ? 0.3 : 2.0);

                // æ ‘å½¢ä½ç½®
                const h = 24, halfH = 12;
                let t = Math.pow(Math.random(), 0.8);
                const y = (t * h) - halfH;
                const r = Math.max(0.5, 8 * (1.0 - t)) * (0.8 + Math.random() * 0.4);
                const a = t * 50 * Math.PI + Math.random() * Math.PI;
                this.posTree.set(Math.cos(a) * r, y, Math.sin(a) * r);

                // æ•£å¼€ä½ç½®
                const rs = 12 + Math.random() * 25;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                this.posScatter.set(
                    rs * Math.sin(phi) * Math.cos(theta),
                    rs * Math.sin(phi) * Math.sin(theta),
                    rs * Math.cos(phi)
                );
            }

            update(dt, mode) {
                let target = (mode === 'SCATTER' || mode === 'FOCUS') ? this.posScatter : this.posTree;
                this.mesh.position.lerp(target, 2.5 * dt);

                // æœå‘æ§åˆ¶
                if (mode === 'FOCUS' && STATE.focusTarget === this.mesh) {
                    this.mesh.lookAt(camera.position);
                } else if (mode === 'SCATTER') {
                    this.mesh.rotation.x += this.spinSpeed.x * dt;
                    this.mesh.rotation.y += this.spinSpeed.y * dt;
                } else {
                    this.mesh.rotation.set(
                        THREE.MathUtils.lerp(this.mesh.rotation.x, 0, dt),
                        this.mesh.rotation.y + 0.5 * dt,
                        THREE.MathUtils.lerp(this.mesh.rotation.z, 0, dt)
                    );
                }

                // ç¼©æ”¾æ§åˆ¶
                let s = this.baseScale;
                if ((mode === 'SCATTER' || mode === 'FOCUS') && this.type === 'PHOTO') {
                    s = this.baseScale * 2.5;
                }
                this.mesh.scale.lerp(new THREE.Vector3(s, s, s), 4 * dt);
            }
        }

        // åˆ›å»ºç²’å­ç³»ç»Ÿ
        function createParticles() {
            // ä½¿ç”¨æ›´å°çš„çƒä½“ä½œä¸ºç²’å­
            const particleGeometry = new THREE.SphereGeometry(0.08, 12, 12);

            // åˆ›å»ºé€æ˜å‘å…‰æè´¨
            const createGlowMaterial = (color, emissiveColor) => {
                return new THREE.MeshBasicMaterial({
                    color: color,
                    transparent: true,
                    opacity: 0.9,  // æé«˜åˆ°0.9ï¼Œæ›´äº®
                    emissive: emissiveColor,
                    emissiveIntensity: 2.5,  // æé«˜åˆ°2.5ï¼Œå‘å…‰æ›´å¼º
                    blending: THREE.AdditiveBlending,
                    depthWrite: false
                });
            };

            // å®šä¹‰ç²’å­æè´¨ - ä½¿ç”¨æ›´äº®çš„é¢œè‰²
            const particleMaterials = {
                green: createGlowMaterial(0x7fffd4, 0x00ff7f),      // æ›´äº®çš„ç»¿è‰²
                gold: createGlowMaterial(0xffd700, 0xffff00),       // æ›´äº®çš„é‡‘è‰²
                red: createGlowMaterial(0xff6b6b, 0xff4444),        // æ›´äº®çš„çº¢è‰²
                blue: createGlowMaterial(0x87ceeb, 0x00bfff),       // æ›´äº®çš„è“è‰²
                pink: createGlowMaterial(0xffb6c1, 0xff69b4),       // æ›´äº®çš„ç²‰è‰²
                white: createGlowMaterial(0xffffff, 0xffffff)       // çº¯ç™½è‰²
            };

            // åˆ›å»ºæ›´å¤šç²’å­ï¼Œå½¢æˆæ›´å¯†é›†çš„æ•ˆæœ
            for (let i = 0; i < 4000; i++) {
                const r = Math.random();
                let material, type;

                // éšæœºé€‰æ‹©é¢œè‰²
                if (r < 0.35) {
                    material = particleMaterials.green;
                    type = 'GREEN';
                } else if (r < 0.55) {
                    material = particleMaterials.gold;
                    type = 'GOLD';
                } else if (r < 0.70) {
                    material = particleMaterials.red;
                    type = 'RED';
                } else if (r < 0.82) {
                    material = particleMaterials.blue;
                    type = 'BLUE';
                } else if (r < 0.92) {
                    material = particleMaterials.pink;
                    type = 'PINK';
                } else {
                    material = particleMaterials.white;
                    type = 'WHITE';
                }

                const mesh = new THREE.Mesh(particleGeometry, material);

                // éšæœºå¤§å°ï¼Œåˆ›é€ æ·±åº¦æ„Ÿ
                const s = 0.5 + Math.random() * 0.8;  // 0.5-1.3ï¼Œå¢åŠ èŒƒå›´
                mesh.scale.set(s, s, s);
                mesh.rotation.set(Math.random() * 6, Math.random() * 6, Math.random() * 6);

                mainGroup.add(mesh);
                particleSystem.push(new Particle(mesh, type));
            }

            // é¡¶éƒ¨æ˜Ÿæ˜Ÿ - ä¹Ÿæ”¹æˆå‘å…‰æ•ˆæœ
            const starMaterial = new THREE.MeshBasicMaterial({
                color: 0xffd700,
                transparent: true,
                opacity: 0.9,
                emissive: 0xffaa00,
                emissiveIntensity: 2.0,
                blending: THREE.AdditiveBlending
            });
            const star = new THREE.Mesh(new THREE.OctahedronGeometry(1.2, 0), starMaterial);
            star.position.set(0, 13.2, 0);
            mainGroup.add(star);

            mainGroup.add(photoMeshGroup);
        }

        // åˆ›å»ºé¢å¤–çš„åœ£è¯è£…é¥°å…ƒç´ 
        function createChristmasDecorations() {
            // åˆ›å»ºé£˜è½çš„åœ£è¯è£…é¥°ç²’å­ï¼ˆæ›´é€æ˜ã€æ›´æ¢¦å¹»ï¼‰
            const decorationGeometry = new THREE.BufferGeometry();
            const decorationCount = 300;  // å¢åŠ æ•°é‡
            const positions = new Float32Array(decorationCount * 3);
            const colors = new Float32Array(decorationCount * 3);
            const sizes = new Float32Array(decorationCount);

            // æ›´äº®çš„åœ£è¯é…è‰²
            const christmasColors = [
                { r: 1.0, g: 0.3, b: 0.3 },   // äº®çº¢è‰²
                { r: 0.3, g: 1.0, b: 0.5 },   // äº®ç»¿è‰²
                { r: 1.0, g: 0.9, b: 0.2 },   // äº®é‡‘è‰²
                { r: 0.4, g: 0.7, b: 1.0 },   // äº®è“è‰²
                { r: 1.0, g: 0.7, b: 0.9 }    // ç²‰è‰²
            ];

            for (let i = 0; i < decorationCount; i++) {
                const i3 = i * 3;
                // éšæœºä½ç½®
                positions[i3] = (Math.random() - 0.5) * 60;
                positions[i3 + 1] = Math.random() * 50 - 10;
                positions[i3 + 2] = (Math.random() - 0.5) * 60;

                // éšæœºåœ£è¯é¢œè‰²
                const color = christmasColors[Math.floor(Math.random() * christmasColors.length)];
                colors[i3] = color.r;
                colors[i3 + 1] = color.g;
                colors[i3 + 2] = color.b;

                // éšæœºå¤§å°
                sizes[i] = Math.random() * 0.6 + 0.3;
            }

            decorationGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            decorationGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            decorationGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            const decorationMaterial = new THREE.PointsMaterial({
                size: 0.8,  // ä»0.6å¢åŠ åˆ°0.8
                vertexColors: true,
                transparent: true,
                opacity: 0.8,  // ä»0.6æé«˜åˆ°0.8
                blending: THREE.AdditiveBlending,
                sizeAttenuation: true,
                depthWrite: false
            });

            const decorationSystem = new THREE.Points(decorationGeometry, decorationMaterial);
            scene.add(decorationSystem);

            // æ·»åŠ åœ£è¯å½©ç¯æ•ˆæœï¼ˆæ›´äº®ã€æ›´é€æ˜ï¼‰
            const lightCount = 150;  // å¢åŠ å½©ç¯æ•°é‡
            const lightGeometry = new THREE.BufferGeometry();
            const lightPositions = new Float32Array(lightCount * 3);
            const lightColors = new Float32Array(lightCount * 3);

            for (let i = 0; i < lightCount; i++) {
                const i3 = i * 3;
                const angle = (i / lightCount) * Math.PI * 2 * 5;
                const radius = 8 + Math.random() * 4;
                const height = (i / lightCount) * 20 - 5;

                lightPositions[i3] = Math.cos(angle) * radius;
                lightPositions[i3 + 1] = height;
                lightPositions[i3 + 2] = Math.sin(angle) * radius;

                // æ›´äº®çš„å½©ç¯é¢œè‰²
                const lightColor = christmasColors[Math.floor(Math.random() * christmasColors.length)];
                lightColors[i3] = lightColor.r;
                lightColors[i3 + 1] = lightColor.g;
                lightColors[i3 + 2] = lightColor.b;
            }

            lightGeometry.setAttribute('position', new THREE.BufferAttribute(lightPositions, 3));
            lightGeometry.setAttribute('color', new THREE.BufferAttribute(lightColors, 3));

            const lightMaterial = new THREE.PointsMaterial({
                size: 0.5,  // ä»0.4å¢åŠ åˆ°0.5
                vertexColors: true,
                transparent: true,
                opacity: 1.0,  // ä»0.8æé«˜åˆ°1.0ï¼Œå®Œå…¨ä¸é€æ˜
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });

            const christmasLights = new THREE.Points(lightGeometry, lightMaterial);
            mainGroup.add(christmasLights);
        }

        // åˆ›å»ºé›ªèŠ±
        function createSnow() {
            const positions = new Float32Array(18000);  // 6000ä¸ªé›ªèŠ± * 3åæ ‡
            for (let i = 0; i < 18000; i += 3) {
                positions[i] = (Math.random() - 0.5) * 100;  // æ‰©å¤§XèŒƒå›´
                positions[i + 1] = (Math.random() - 0.5) * 100 + 20;  // æ‰©å¤§YèŒƒå›´
                positions[i + 2] = (Math.random() - 0.5) * 100;  // æ‰©å¤§ZèŒƒå›´
            }

            snowSystem = new THREE.Points(
                new THREE.BufferGeometry().setAttribute('position', new THREE.BufferAttribute(positions, 3)),
                new THREE.PointsMaterial({
                    color: 0xffffff,
                    size: 0.25,  // ç¨å¾®å¢å¤§é›ªèŠ±
                    transparent: true,
                    opacity: 0.7,  // å¢åŠ ä¸é€æ˜åº¦
                    blending: THREE.AdditiveBlending
                })
            );
            scene.add(snowSystem);
        }

        // åˆ›å»ºé»˜è®¤ç…§ç‰‡
        let defaultPhotoTexture;
        function createDefaultPhotos() {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 512;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, 512, 512);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 15;
            ctx.strokeRect(20, 20, 472, 472);
            ctx.font = '500 60px Times New Roman';
            ctx.fillStyle = '#aaddff';
            ctx.textAlign = 'center';
            ctx.fillText("é¢„ç¥å®¶äººä»¬", 256, 230);
            ctx.fillText("åœ£è¯å¿«ä¹ï¼", 256, 300);

            defaultPhotoTexture = new THREE.CanvasTexture(canvas);
            defaultPhotoTexture.colorSpace = THREE.SRGBColorSpace;
            addPhotoToScene(defaultPhotoTexture);
        }

        // æ·»åŠ ç…§ç‰‡åˆ°åœºæ™¯
        function addPhotoToScene(texture, base64Data = null, photoId = null) {
            const ar = texture.image.width / texture.image.height;
            const w = ar > 1 ? 1.2 : 1.2 * ar;
            const h = ar > 1 ? 1.2 / ar : 1.2;

            const group = new THREE.Group();
            group.add(new THREE.Mesh(
                new THREE.BoxGeometry(w + 0.1, h + 0.1, 0.05),
                MATERIALS.frame
            ));

            const photo = new THREE.Mesh(
                new THREE.PlaneGeometry(w, h),
                new THREE.MeshBasicMaterial({ map: texture })
            );
            photo.position.z = 0.04;
            group.add(photo);
            group.scale.setScalar(0.8);

            // å­˜å‚¨photoIdä»¥ä¾¿åç»­ç®¡ç†
            if (photoId) {
                group.userData.photoId = photoId;
                photoIdToMeshMap.set(photoId, group);
            }

            photoMeshGroup.add(group);
            particleSystem.push(new Particle(group, 'PHOTO'));

            // ä¿å­˜base64æ•°æ®
            if (base64Data) {
                photoDataArray.push(base64Data);
            }

            return group;
        }

        // ä»åœºæ™¯ç§»é™¤ç…§ç‰‡
        function removePhotoFromScene(photoId) {
            const mesh = photoIdToMeshMap.get(photoId);
            if (mesh) {
                // ä»ç²’å­ç³»ç»Ÿä¸­ç§»é™¤
                const particleIndex = particleSystem.findIndex(p => p.mesh === mesh);
                if (particleIndex !== -1) {
                    particleSystem.splice(particleIndex, 1);
                }
                // ä»åœºæ™¯ä¸­ç§»é™¤
                photoMeshGroup.remove(mesh);
                // æ¸…ç†æ˜ å°„
                photoIdToMeshMap.delete(photoId);

                // ä»photoDataArrayä¸­ç§»é™¤å¯¹åº”çš„base64æ•°æ®
                // éœ€è¦é€šè¿‡meshçš„userDataæˆ–å…¶ä»–æ–¹å¼æ‰¾åˆ°å¯¹åº”ç´¢å¼•
                return true;
            }
            return false;
        }

        // åå¤„ç†
        function setupPostProcessing() {
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1.5,
                0.4,
                0.85
            );
            composer.addPass(bloomPass);
        }

        // äº‹ä»¶ç›‘å¬
        function setupEvents() {
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });

            // éŸ³ä¹æ§åˆ¶ - æ‰“å¼€éŸ³ä¹ç®¡ç†æ¨¡æ€æ¡†
            const musicBtn = document.getElementById('music-btn');
            musicBtn.addEventListener('click', () => {
                document.getElementById('music-modal').classList.add('show');
            });

            // é”®ç›˜æ§åˆ¶æ˜¾ç¤ºéšè—
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();

                // Vé”® - åˆ‡æ¢æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                if (key === 'v') {
                    const webcamWrapper = document.getElementById('webcam-wrapper');
                    webcamWrapper.style.display = webcamWrapper.style.display === 'none' ? 'block' : 'none';
                }

                // Fé”® - åˆ‡æ¢å…¨å±
                if (key === 'f') {
                    if (!document.fullscreenElement) {
                        document.documentElement.requestFullscreen().catch(err => {
                            console.log('å…¨å±åˆ‡æ¢å¤±è´¥:', err);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                }

                // Hé”® - åˆ‡æ¢å…¶ä»–æ§ä»¶ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ã€æç¤ºï¼‰
                if (key === 'h') {
                    const h1 = document.querySelector('h1');
                    const uploadWrapper = document.querySelector('.upload-wrapper');
                    const tips = document.getElementById('tips');

                    const isHidden = h1.style.display === 'none';
                    const newDisplay = isHidden ? '' : 'none';

                    if (h1) h1.style.display = newDisplay;
                    if (uploadWrapper) uploadWrapper.style.display = newDisplay;
                    if (tips) tips.style.display = newDisplay;
                }

                // Lé”® - è§¦å‘ä¹¦ä¿¡å±•ç¤º
                if (key === 'l') {
                    triggerLetterDisplay();
                }

                // é”®ç›˜äº¤äº’ - æ›¿ä»£æ‰‹åŠ¿æ§åˆ¶ï¼ˆé€‚ç”¨äºæ²¡æœ‰æ‘„åƒå¤´çš„ç”µè„‘ï¼‰
                // 1é”®æˆ–Té”® - åœ£è¯æ ‘æ¨¡å¼ï¼ˆå¯¹åº”æ¡æ‹³æ‰‹åŠ¿ï¼‰
                if (key === '1' || key === 't') {
                    STATE.mode = 'TREE';
                    STATE.focusTarget = null;
                }

                // 2é”®æˆ–Sé”® - æ˜Ÿæ²³æ•£å¼€æ¨¡å¼ï¼ˆå¯¹åº”å¼ æ‰‹æ‰‹åŠ¿ï¼‰
                if (key === '2' || key === 's') {
                    STATE.mode = 'SCATTER';
                    STATE.focusTarget = null;
                }

                // 3é”®æˆ–Pé”® - é”å®šç…§ç‰‡æ¨¡å¼ï¼ˆå¯¹åº”æåˆæ‰‹åŠ¿ï¼‰
                if (key === '3' || key === 'p') {
                    STATE.mode = 'FOCUS';
                    if (!STATE.focusTarget) {
                        const photos = particleSystem.filter(p => p.type === 'PHOTO');
                        if (photos.length) {
                            STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                        }
                    }
                }

                // Né”® - åˆ‡æ¢åˆ°ä¸‹ä¸€å¼ ç…§ç‰‡ï¼ˆåœ¨FOCUSæ¨¡å¼ä¸‹ï¼‰
                if (key === 'n' && STATE.mode === 'FOCUS') {
                    const photos = particleSystem.filter(p => p.type === 'PHOTO');
                    if (photos.length > 1) {
                        const currentIndex = photos.findIndex(p => p.mesh === STATE.focusTarget);
                        const nextIndex = (currentIndex + 1) % photos.length;
                        STATE.focusTarget = photos[nextIndex].mesh;
                    }
                }
            });

            // ç¼“å­˜ç®¡ç†æ¨¡æ€æ¡†
            setupCacheManagement();
            // å¯¼å‡ºå‘½åå¯¹è¯æ¡†
            setupExportNameModal();
            // éŸ³ä¹ç®¡ç†
            setupMusicManagement();
        }

        // ç¼“å­˜ç®¡ç†åŠŸèƒ½
        function setupCacheManagement() {
            const modal = document.getElementById('cache-modal');
            const manageBtn = document.getElementById('manage-btn');
            const closeBtn = document.getElementById('modal-close');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const photoGrid = document.getElementById('photo-grid');
            const cacheStats = document.getElementById('cache-stats');

            // æ‰“å¼€æ¨¡æ€æ¡†
            manageBtn.addEventListener('click', () => {
                modal.classList.add('show');
                renderPhotoGrid();
            });

            // å…³é—­æ¨¡æ€æ¡†
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });

            // æ¸…ç©ºå…¨éƒ¨ç¼“å­˜
            clearAllBtn.addEventListener('click', async () => {
                if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜çš„ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

                // ä»åœºæ™¯ä¸­ç§»é™¤æ‰€æœ‰ç…§ç‰‡
                const photos = await PhotoCache.getAllPhotos();
                photos.forEach(photo => {
                    removePhotoFromScene(photo.id);
                });

                // æ¸…ç©ºç¼“å­˜
                await PhotoCache.clearAll();
                photoDataArray = [];

                renderPhotoGrid();
                alert('å·²æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ç…§ç‰‡ï¼');
            });

            // ä¸Šä¼ ç…§ç‰‡
            document.getElementById('file-input').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                let uploadedCount = 0;
                let failedCount = 0;
                let processedCount = 0;
                let firstErrorMessage = '';

                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64 = ev.target.result;

                        // å…ˆä¿å­˜åˆ°ç¼“å­˜
                        const result = await PhotoCache.savePhoto(base64);
                        if (!result.success) {
                            failedCount++;
                            if (!firstErrorMessage) {
                                firstErrorMessage = result.message;
                            }
                            processedCount++;
                            // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆåæ˜¾ç¤ºç»“æœ
                            if (processedCount === files.length) {
                                renderPhotoGrid();
                                if (failedCount > 0) {
                                    alert(firstErrorMessage + (failedCount > 1 ? `\nå…± ${failedCount} å¼ ç…§ç‰‡æœªèƒ½ä¸Šä¼ ` : ''));
                                }
                            }
                            return;
                        }

                        // åŠ è½½çº¹ç†å¹¶æ·»åŠ åˆ°åœºæ™¯
                        new THREE.TextureLoader().load(base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, base64, result.photo.id);
                            uploadedCount++;
                            processedCount++;

                            // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆåæ˜¾ç¤ºç»“æœ
                            if (processedCount === files.length) {
                                renderPhotoGrid();
                                if (failedCount > 0) {
                                    alert(firstErrorMessage + (failedCount > 1 ? `\nå…± ${failedCount} å¼ ç…§ç‰‡æœªèƒ½ä¸Šä¼ ` : ''));
                                }
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = ''; // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤ä¸Šä¼ 
            });

            // å¯¼å…¥ç…§ç‰‡
            document.getElementById('import-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const importData = JSON.parse(ev.target.result);

                        if (!importData.photos || !Array.isArray(importData.photos)) {
                            alert('æ— æ•ˆçš„ç…§ç‰‡æ•°æ®æ ¼å¼ï¼');
                            return;
                        }

                        let loadedCount = 0;
                        let failedCount = 0;

                        for (const base64 of importData.photos) {
                            // å…ˆä¿å­˜åˆ°ç¼“å­˜
                            const result = await PhotoCache.savePhoto(base64);
                            if (!result.success) {
                                failedCount++;
                                if (failedCount === 1) {
                                    alert(result.message);
                                }
                                continue;
                            }

                            await new Promise((resolve) => {
                                new THREE.TextureLoader().load(base64, (texture) => {
                                    texture.colorSpace = THREE.SRGBColorSpace;
                                    addPhotoToScene(texture, base64, result.photo.id);
                                    loadedCount++;
                                    resolve();
                                });
                            });
                        }

                        renderPhotoGrid();

                        if (loadedCount > 0) {
                            alert(`æˆåŠŸå¯¼å…¥ ${loadedCount} å¼ ç…§ç‰‡ï¼${failedCount > 0 ? `\n${failedCount} å¼ å› ç¼“å­˜é™åˆ¶æœªèƒ½å¯¼å…¥` : ''}`);
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        alert('å¯¼å…¥å¤±è´¥ï¼è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚');
                    }
                };
                reader.readAsText(file);
                e.target.value = ''; // æ¸…ç©ºinputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
            });

            // å¯¼å‡ºç…§ç‰‡ - æ˜¾ç¤ºå‘½åå¯¹è¯æ¡†
            document.getElementById('export-btn').addEventListener('click', async () => {
                const photos = await PhotoCache.getAllPhotos();
                if (photos.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç…§ç‰‡ï¼è¯·å…ˆä¸Šä¼ ç…§ç‰‡ã€‚');
                    return;
                }

                // æ˜¾ç¤ºå‘½åå¯¹è¯æ¡†
                showExportNameModal();
            });

            // æ¸²æŸ“ç…§ç‰‡ç½‘æ ¼
            async function renderPhotoGrid() {
                const photos = await PhotoCache.getAllPhotos();
                const stats = await PhotoCache.getStats();

                // è·å–å®é™…å­˜å‚¨ç©ºé—´ä¿¡æ¯
                let storageInfo = { usedPercent: 0, quotaMB: CACHE_CONFIG.maxSizeMB, isWarning: false };
                if (navigator.storage && navigator.storage.estimate) {
                    try {
                        const estimate = await navigator.storage.estimate();
                        storageInfo.usedPercent = (estimate.usage / estimate.quota) * 100;
                        storageInfo.quotaMB = Math.round(estimate.quota / (1024 * 1024));
                        storageInfo.isWarning = storageInfo.usedPercent >= CACHE_CONFIG.warnAtPercent;
                    } catch (e) {
                        console.warn('æ— æ³•è·å–å­˜å‚¨ä¿¡æ¯:', e);
                    }
                }

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                cacheStats.innerHTML = `å·²ç¼“å­˜ <span class="${storageInfo.isWarning ? 'warning' : 'highlight'}">${stats.count}</span> å¼ ç…§ç‰‡ ` +
                    `(<span class="${storageInfo.isWarning ? 'warning' : 'highlight'}">${PhotoCache.formatSize(stats.totalSize)}</span>)` +
                    (storageInfo.isWarning ? ` <span class="warning">âš  å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡ ${storageInfo.usedPercent.toFixed(0)}%</span>` : '');

                // æ¸²æŸ“ç…§ç‰‡åˆ—è¡¨
                if (photos.length === 0) {
                    photoGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“·</div>
                            <div>æš‚æ— ç¼“å­˜ç…§ç‰‡</div>
                            <div style="margin-top:10px; font-size:9px;">ä¸Šä¼ ç…§ç‰‡åä¼šè‡ªåŠ¨ç¼“å­˜åˆ°æœ¬åœ°</div>
                        </div>
                    `;
                    return;
                }

                photoGrid.innerHTML = photos.map(photo => {
                    const isInScene = photoIdToMeshMap.has(photo.id);
                    return `
                        <div class="photo-item ${isInScene ? 'in-scene' : ''}" data-id="${photo.id}">
                            <img class="photo-thumb" src="${photo.base64}" alt="ç…§ç‰‡">
                            <div class="photo-info">
                                <div class="photo-size">${PhotoCache.formatSize(photo.size)}</div>
                                <div class="photo-status">${isInScene ? 'âœ“ å·²æ·»åŠ åˆ°åœºæ™¯' : 'æœªæ·»åŠ '}</div>
                                <div class="photo-actions">
                                    ${isInScene ?
                            `<button class="photo-action-btn remove-scene" data-action="remove" data-id="${photo.id}">ä»åœºæ™¯ç§»é™¤</button>` :
                            `<button class="photo-action-btn add-scene" data-action="add" data-id="${photo.id}">æ·»åŠ åˆ°åœºæ™¯</button>`
                        }
                                    <button class="photo-action-btn delete" data-action="delete" data-id="${photo.id}">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                photoGrid.querySelectorAll('.photo-action-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const action = e.target.dataset.action;
                        const photoId = e.target.dataset.id;

                        if (action === 'add') {
                            await addPhotoToSceneFromCache(photoId);
                        } else if (action === 'remove') {
                            await removePhotoAndUpdateCache(photoId);
                        } else if (action === 'delete') {
                            await deletePhotoFromCache(photoId);
                        }

                        renderPhotoGrid();
                    });
                });
            }

            // ä»ç¼“å­˜æ·»åŠ ç…§ç‰‡åˆ°åœºæ™¯
            async function addPhotoToSceneFromCache(photoId) {
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (!photo) return;

                await new Promise((resolve) => {
                    new THREE.TextureLoader().load(photo.base64, (texture) => {
                        texture.colorSpace = THREE.SRGBColorSpace;
                        addPhotoToScene(texture, photo.base64, photo.id);
                        resolve();
                    });
                });

                // æ›´æ–°ç¼“å­˜ä¸­çš„çŠ¶æ€
                photo.inScene = true;
                await PhotoCache.updatePhoto(photo);
            }

            // ä»åœºæ™¯ç§»é™¤ç…§ç‰‡å¹¶æ›´æ–°ç¼“å­˜
            async function removePhotoAndUpdateCache(photoId) {
                removePhotoFromScene(photoId);

                // æ›´æ–°ç¼“å­˜ä¸­çš„çŠ¶æ€
                const photos = await PhotoCache.getAllPhotos();
                const photo = photos.find(p => p.id === photoId);
                if (photo) {
                    photo.inScene = false;
                    await PhotoCache.updatePhoto(photo);
                }
            }

            // ä»ç¼“å­˜ä¸­åˆ é™¤ç…§ç‰‡
            async function deletePhotoFromCache(photoId) {
                if (!confirm('ç¡®å®šè¦ä»ç¼“å­˜ä¸­åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) return;

                // å¦‚æœåœ¨åœºæ™¯ä¸­ï¼Œå…ˆç§»é™¤
                removePhotoFromScene(photoId);

                // ä»ç¼“å­˜ä¸­åˆ é™¤
                await PhotoCache.deletePhoto(photoId);
            }
        }

        // æ˜¾ç¤ºå¯¼å‡ºå‘½åå¯¹è¯æ¡†
        function showExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const themeInput = document.getElementById('export-theme');
            const customInput = document.getElementById('export-custom');
            const dateInput = document.getElementById('export-date');
            const previewSpan = document.getElementById('filename-preview');

            // è®¾ç½®é»˜è®¤å€¼
            themeInput.value = 'Merry Christmas';
            customInput.value = '';
            dateInput.value = new Date().toISOString().split('T')[0]; // 2024-12-14æ ¼å¼

            // æ›´æ–°é¢„è§ˆ
            function updatePreview() {
                const theme = themeInput.value.trim() || 'Merry Christmas';
                const custom = customInput.value.trim();
                const date = dateInput.value;

                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                previewSpan.textContent = filename;
            }

            updatePreview();

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰
            const newThemeInput = themeInput.cloneNode(true);
            const newCustomInput = customInput.cloneNode(true);
            themeInput.parentNode.replaceChild(newThemeInput, themeInput);
            customInput.parentNode.replaceChild(newCustomInput, customInput);

            // é‡æ–°è·å–å…ƒç´ å¹¶ç»‘å®šäº‹ä»¶
            document.getElementById('export-theme').addEventListener('input', updatePreview);
            document.getElementById('export-custom').addEventListener('input', updatePreview);

            modal.classList.add('show');
        }

        // è®¾ç½®å¯¼å‡ºå‘½åå¯¹è¯æ¡†äº‹ä»¶
        function setupExportNameModal() {
            const modal = document.getElementById('export-name-modal');
            const closeBtn = document.getElementById('export-name-close');
            const cancelBtn = document.getElementById('export-cancel');
            const confirmBtn = document.getElementById('export-confirm');

            // å…³é—­å¯¹è¯æ¡†
            closeBtn.addEventListener('click', () => modal.classList.remove('show'));
            cancelBtn.addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // ç¡®è®¤å¯¼å‡º
            confirmBtn.addEventListener('click', async () => {
                const theme = document.getElementById('export-theme').value.trim() || 'Merry Christmas';
                const custom = document.getElementById('export-custom').value.trim();
                const date = document.getElementById('export-date').value;

                // ç”Ÿæˆæ–‡ä»¶å
                let filename = '';
                if (custom) {
                    filename = custom + '_';
                }
                filename += theme + '_' + date + '.json';

                // æ‰§è¡Œå¯¼å‡º
                const photos = await PhotoCache.getAllPhotos();
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    photos: photos.map(p => p.base64)
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                modal.classList.remove('show');
                alert(`æˆåŠŸå¯¼å‡º ${photos.length} å¼ ç…§ç‰‡ï¼\næ–‡ä»¶å: ${filename}`);
            });
        }

        // æ‘„åƒå¤´æƒé™è¯¢é—®å¼¹çª—
        function setupCameraPermissionModal() {
            return new Promise((resolve) => {
                const modal = document.getElementById('camera-permission-modal');
                const allowBtn = document.getElementById('camera-allow-btn');
                const denyBtn = document.getElementById('camera-deny-btn');
                const loader = document.getElementById('loader');

                // æ˜¾ç¤ºå¼¹çª—
                modal.classList.add('show');

                // éšè—loaderçš„å‡½æ•°
                function hideLoader() {
                    if (loader) {
                        loader.style.opacity = 0;
                        setTimeout(() => loader.remove(), 300);
                    }
                }

                // å¼€å¯æ‘„åƒå¤´
                allowBtn.addEventListener('click', async () => {
                    modal.classList.remove('show');
                    // loaderä¿æŒæ˜¾ç¤ºï¼Œç­‰å¾…æ‘„åƒå¤´æˆæƒ
                    try {
                        await initMediaPipe();
                    } catch (error) {
                        console.warn('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨é”®ç›˜æ§åˆ¶:', error);
                        // éšè—æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                        document.getElementById('webcam-wrapper').style.display = 'none';
                    }
                    hideLoader();  // æˆæƒå®Œæˆåæ‰éšè—loader
                    resolve();
                });

                // ä¸å¼€å¯æ‘„åƒå¤´
                denyBtn.addEventListener('click', () => {
                    modal.classList.remove('show');
                    hideLoader();
                    // éšè—æ‘„åƒå¤´é¢„è§ˆåŒºåŸŸ
                    document.getElementById('webcam-wrapper').style.display = 'none';
                    resolve();
                });
            });
        }

        // éŸ³ä¹ç®¡ç†åŠŸèƒ½ï¼ˆä½¿ç”¨é¢„è®¾éŸ³ä¹é…ç½®ï¼‰
        const DEFAULT_MUSIC_URL = PRESET_MUSIC.background;
        let currentMusicName = 'é»˜è®¤éŸ³ä¹';
        let currentMusicData = null; // å­˜å‚¨ä¸Šä¼ çš„éŸ³ä¹base64

        function setupMusicManagement() {
            const modal = document.getElementById('music-modal');
            const bgMusic = document.getElementById('bg-music');
            const mainMusicBtn = document.getElementById('music-btn');

            // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®
            document.getElementById('music-modal-close').addEventListener('click', () => modal.classList.remove('show'));
            document.getElementById('music-close-btn').addEventListener('click', () => modal.classList.remove('show'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            // Tabåˆ‡æ¢
            const tabs = document.querySelectorAll('.music-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const tabId = tab.dataset.tab;
                    document.getElementById('tab-url').style.display = tabId === 'url' ? 'block' : 'none';
                    document.getElementById('tab-upload').style.display = tabId === 'upload' ? 'block' : 'none';
                });
            });

            // åº”ç”¨URLæŒ‰é’®
            document.getElementById('apply-url-btn').addEventListener('click', () => {
                const urlInput = document.getElementById('music-url-input');
                const url = urlInput.value.trim();

                if (!url) {
                    alert('è¯·è¾“å…¥éŸ³ä¹é“¾æ¥ï¼');
                    return;
                }

                // éªŒè¯URLæ ¼å¼
                try {
                    new URL(url);
                } catch {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URLé“¾æ¥ï¼');
                    return;
                }

                applyMusicSource(url, getFileNameFromUrl(url));
            });

            // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const uploadArea = document.getElementById('music-upload-area');
            const fileInput = document.getElementById('music-file-input');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('audio/')) {
                    handleAudioFile(file);
                } else {
                    alert('è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼');
                }
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleAudioFile(file);
                }
                e.target.value = '';
            });

            // å¤„ç†éŸ³é¢‘æ–‡ä»¶
            function handleAudioFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    currentMusicData = base64;
                    applyMusicSource(base64, file.name);
                };
                reader.readAsDataURL(file);
            }

            // åº”ç”¨éŸ³ä¹æº
            function applyMusicSource(src, name) {
                const wasPlaying = !bgMusic.paused;

                bgMusic.src = src;
                currentMusicName = name || 'è‡ªå®šä¹‰éŸ³ä¹';
                updateMusicInfo();

                // ä¿å­˜åˆ°localStorage
                saveMusicSettings(src, currentMusicName);

                if (wasPlaying) {
                    bgMusic.play().catch(err => console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', err));
                }

                alert(`å·²åº”ç”¨éŸ³ä¹: ${currentMusicName}`);
            }

            // æ’­æ”¾/æš‚åœæ§åˆ¶
            const playBtn = document.getElementById('music-play-btn');
            const pauseBtn = document.getElementById('music-pause-btn');

            playBtn.addEventListener('click', () => {
                bgMusic.play().then(() => {
                    updatePlayState(true);
                }).catch(err => {
                    console.log('æ’­æ”¾å¤±è´¥:', err);
                    alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æºæ˜¯å¦æœ‰æ•ˆ');
                });
            });

            pauseBtn.addEventListener('click', () => {
                bgMusic.pause();
                updatePlayState(false);
            });

            // ç›‘å¬éŸ³é¢‘çŠ¶æ€å˜åŒ–
            bgMusic.addEventListener('play', () => updatePlayState(true));
            bgMusic.addEventListener('pause', () => updatePlayState(false));

            function updatePlayState(playing) {
                if (playing) {
                    playBtn.classList.add('playing');
                    mainMusicBtn.classList.add('active');
                    mainMusicBtn.textContent = 'ğŸµ æ’­æ”¾ä¸­';
                } else {
                    playBtn.classList.remove('playing');
                    mainMusicBtn.classList.remove('active');
                    mainMusicBtn.textContent = 'ğŸµ éŸ³ä¹';
                }
            }

            // éŸ³é‡æ§åˆ¶
            const volumeSlider = document.getElementById('music-volume');
            const volumeValue = document.getElementById('volume-value');

            volumeSlider.addEventListener('input', () => {
                const volume = volumeSlider.value / 100;
                bgMusic.volume = volume;
                volumeValue.textContent = volumeSlider.value + '%';
                localStorage.setItem('musicVolume', volumeSlider.value);
            });

            // æ¢å¤é»˜è®¤
            document.getElementById('music-reset-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤éŸ³ä¹å—ï¼Ÿ')) {
                    bgMusic.src = DEFAULT_MUSIC_URL;
                    currentMusicName = 'é»˜è®¤éŸ³ä¹';
                    currentMusicData = null;
                    updateMusicInfo();
                    document.getElementById('music-url-input').value = '';
                    localStorage.removeItem('musicSrc');
                    localStorage.removeItem('musicName');
                    alert('å·²æ¢å¤é»˜è®¤éŸ³ä¹');
                }
            });

            // æ›´æ–°éŸ³ä¹ä¿¡æ¯æ˜¾ç¤º
            function updateMusicInfo() {
                document.getElementById('current-music-name').textContent = currentMusicName;
            }

            // ä¿å­˜éŸ³ä¹è®¾ç½®
            function saveMusicSettings(src, name) {
                // å¦‚æœæ˜¯base64æ•°æ®ï¼ˆä¸Šä¼ çš„æ–‡ä»¶ï¼‰ï¼Œä¿å­˜åˆ°localStorage
                if (src.startsWith('data:')) {
                    localStorage.setItem('musicSrc', src);
                } else {
                    localStorage.setItem('musicSrc', src);
                }
                localStorage.setItem('musicName', name);
            }

            // æ¢å¤éŸ³ä¹è®¾ç½®
            function restoreMusicSettings() {
                const savedSrc = localStorage.getItem('musicSrc');
                const savedName = localStorage.getItem('musicName');
                const savedVolume = localStorage.getItem('musicVolume');

                if (savedSrc) {
                    bgMusic.src = savedSrc;
                    currentMusicName = savedName || 'è‡ªå®šä¹‰éŸ³ä¹';
                    if (savedSrc.startsWith('data:')) {
                        currentMusicData = savedSrc;
                    }
                    updateMusicInfo();
                }

                if (savedVolume) {
                    volumeSlider.value = savedVolume;
                    bgMusic.volume = savedVolume / 100;
                    volumeValue.textContent = savedVolume + '%';
                } else {
                    bgMusic.volume = 0.5;
                }
            }

            // ä»URLä¸­æå–æ–‡ä»¶å
            function getFileNameFromUrl(url) {
                try {
                    const pathname = new URL(url).pathname;
                    const filename = pathname.split('/').pop();
                    return decodeURIComponent(filename) || 'åœ¨çº¿éŸ³ä¹';
                } catch {
                    return 'åœ¨çº¿éŸ³ä¹';
                }
            }

            // åˆå§‹åŒ–æ—¶æ¢å¤è®¾ç½®
            restoreMusicSettings();
        }

        // ä»ç¼“å­˜æ¢å¤ç…§ç‰‡åˆ°åœºæ™¯
        async function restorePhotosFromCache() {
            const photos = await PhotoCache.getAllPhotos();

            for (const photo of photos) {
                if (photo.inScene) {
                    await new Promise((resolve) => {
                        new THREE.TextureLoader().load(photo.base64, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            addPhotoToScene(texture, photo.base64, photo.id);
                            resolve();
                        });
                    });
                }
            }

            if (photos.length > 0) {
                console.log(`å·²ä»ç¼“å­˜æ¢å¤ ${photos.filter(p => p.inScene).length} å¼ ç…§ç‰‡`);
            }
        }

        // åŠ è½½é¢„ç½®ç…§ç‰‡ï¼ˆæ”¯æŒæœ¬åœ°å›¾ç‰‡è·¯å¾„å’Œbase64æ ¼å¼ï¼‰
        async function loadPresetPhotos() {
            if (!PRESET_PHOTOS || PRESET_PHOTOS.length === 0) {
                return;
            }

            console.log(`æ­£åœ¨åŠ è½½ ${PRESET_PHOTOS.length} å¼ é¢„ç½®ç…§ç‰‡...`);
            let loadedCount = 0;

            for (const photoSrc of PRESET_PHOTOS) {
                if (!photoSrc) continue;

                // åˆ¤æ–­æ˜¯ base64 è¿˜æ˜¯æ–‡ä»¶è·¯å¾„
                const isBase64 = photoSrc.startsWith('data:image');

                if (isBase64) {
                    // åŸæœ‰çš„ base64 åŠ è½½é€»è¾‘
                    const photos = await PhotoCache.getAllPhotos();
                    const exists = photos.some(p => p.base64 && p.base64.substring(0, 100) === photoSrc.substring(0, 100));

                    if (!exists) {
                        const result = await PhotoCache.savePhoto(photoSrc);
                        if (result.success) {
                            await new Promise((resolve) => {
                                new THREE.TextureLoader().load(photoSrc, (texture) => {
                                    texture.colorSpace = THREE.SRGBColorSpace;
                                    addPhotoToScene(texture, photoSrc, result.photo.id);
                                    loadedCount++;
                                    resolve();
                                }, undefined, () => {
                                    console.warn(`åŠ è½½å›¾ç‰‡å¤±è´¥: ${photoSrc.substring(0, 50)}...`);
                                    resolve();
                                });
                            });
                        }
                    }
                } else {
                    // æœ¬åœ°æ–‡ä»¶è·¯å¾„åŠ è½½é€»è¾‘ï¼ˆä¸ç¼“å­˜åˆ° IndexedDBï¼Œç›´æ¥åŠ è½½åˆ°åœºæ™¯ï¼‰
                    await new Promise((resolve) => {
                        new THREE.TextureLoader().load(photoSrc, (texture) => {
                            texture.colorSpace = THREE.SRGBColorSpace;
                            // ç›´æ¥æ·»åŠ åˆ°åœºæ™¯ï¼Œä¸ä¿å­˜åˆ°ç¼“å­˜ï¼ˆå› ä¸ºæ˜¯æœ¬åœ°æ–‡ä»¶ï¼‰
                            addPhotoToScene(texture, null, null);
                            loadedCount++;
                            console.log(`å·²åŠ è½½æœ¬åœ°å›¾ç‰‡: ${photoSrc}`);
                            resolve();
                        }, undefined, (error) => {
                            console.warn(`åŠ è½½æœ¬åœ°å›¾ç‰‡å¤±è´¥: ${photoSrc}`, error);
                            resolve();
                        });
                    });
                }
            }

            if (loadedCount > 0) {
                console.log(`å·²åŠ è½½ ${loadedCount} å¼ é¢„ç½®ç…§ç‰‡`);
            }
        }

        // åˆå§‹åŒ– MediaPipe æ‰‹åŠ¿è¯†åˆ«
        async function initMediaPipe() {
            const vision = await FilesetResolver.forVisionTasks(
                "https://testingcf.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );

            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://testingcf.jsdelivr.net/gh/CJcrazycool/mediapipe-mirror@main/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });

            if (navigator.mediaDevices?.getUserMedia) {
                video = document.getElementById('webcam');
                video.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamCanvas = document.getElementById('webcam-preview');
                webcamCtx = webcamCanvas.getContext('2d');
                video.addEventListener("loadeddata", predictWebcam);
            }
        }

        // æ‰‹åŠ¿è¯†åˆ«å¾ªç¯
        let lastTime = -1;
        async function predictWebcam() {
            if (video.currentTime !== lastTime && handLandmarker) {
                lastTime = video.currentTime;
                webcamCanvas.width = video.videoWidth;
                webcamCanvas.height = video.videoHeight;

                webcamCtx.save();
                webcamCtx.clearRect(0, 0, webcamCanvas.width, webcamCanvas.height);
                webcamCtx.drawImage(video, 0, 0);

                const result = handLandmarker.detectForVideo(video, performance.now());

                if (result.landmarks.length) {
                    STATE.hand.detected = true;
                    STATE.hand.x = (result.landmarks[0][9].x - 0.5) * 2;
                    STATE.hand.y = (result.landmarks[0][9].y - 0.5) * 2;

                    const wrist = result.landmarks[0][0];
                    const index = result.landmarks[0][8];
                    const thumb = result.landmarks[0][4];

                    const indexDist = Math.hypot(index.x - wrist.x, index.y - wrist.y);
                    const thumbDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);

                    const isFist = indexDist < 0.3 && thumbDist > 0.08;
                    const isOpen = indexDist > 0.4;
                    const isPinch = thumbDist < 0.08;

                    // æ‰‹åŠ¿é€»è¾‘
                    if (isPinch && (STATE.mode === 'SCATTER' || STATE.mode === 'FOCUS')) {
                        STATE.mode = 'FOCUS';
                        if (!STATE.focusTarget) {
                            const photos = particleSystem.filter(p => p.type === 'PHOTO');
                            if (photos.length) {
                                STATE.focusTarget = photos[Math.floor(Math.random() * photos.length)].mesh;
                            }
                        }
                    } else if (isFist) {
                        STATE.mode = 'TREE';
                        STATE.focusTarget = null;
                    } else if (isOpen) {
                        STATE.mode = 'SCATTER';
                        STATE.focusTarget = null;
                    }

                    // ç‚¹èµæ‰‹åŠ¿æ£€æµ‹
                    const isHeartGesture = detectHeartGesture(result.landmarks);
                    handleHeartGesture(isHeartGesture);

                    // ç»˜åˆ¶æ‰‹éƒ¨éª¨æ¶
                    const landmarks = result.landmarks[0];
                    const connections = [
                        [0, 1], [1, 2], [2, 3], [3, 4],
                        [0, 5], [5, 6], [6, 7], [7, 8],
                        [0, 9], [9, 10], [10, 11], [11, 12],
                        [0, 13], [13, 14], [14, 15], [15, 16],
                        [0, 17], [17, 18], [18, 19], [19, 20],
                        [5, 9], [9, 13], [13, 17]
                    ];

                    webcamCtx.shadowBlur = 8;
                    webcamCtx.shadowColor = '#00ffcc';
                    webcamCtx.lineWidth = 3;
                    webcamCtx.strokeStyle = 'rgba(0, 255, 204, 0.9)';

                    for (let [s, e] of connections) {
                        webcamCtx.beginPath();
                        webcamCtx.moveTo(
                            landmarks[s].x * webcamCanvas.width,
                            landmarks[s].y * webcamCanvas.height
                        );
                        webcamCtx.lineTo(
                            landmarks[e].x * webcamCanvas.width,
                            landmarks[e].y * webcamCanvas.height
                        );
                        webcamCtx.stroke();
                    }

                    // ç»˜åˆ¶å…³é”®èŠ‚ç‚¹
                    webcamCtx.fillStyle = 'rgba(0, 255, 204, 0.8)';
                    for (let i of [0, 4, 8, 12, 16, 20]) {
                        webcamCtx.beginPath();
                        webcamCtx.arc(
                            landmarks[i].x * webcamCanvas.width,
                            landmarks[i].y * webcamCanvas.height,
                            4,
                            0,
                            2 * Math.PI
                        );
                        webcamCtx.fill();
                    }

                    webcamCtx.shadowBlur = 0;
                }

                webcamCtx.restore();
            }
            requestAnimationFrame(predictWebcam);
        }



        function createTips() {
            const tips = document.createElement('div');
            tips.id = 'tips';
            tips.innerHTML = `
                <div style="text-align:center; margin-bottom:10px; color:#fff; font-weight:bold;">æ‰‹åŠ¿æ§åˆ¶</div>
                <div class="tip-item"><span class="tip-key">âœŠ æ¡æ‹³</span> åœ£è¯æ ‘</div>
                <div class="tip-item"><span class="tip-key">âœ‹ å¼ æ‰‹</span> æ˜Ÿæ²³æ•£å¼€</div>
                <div class="tip-item"><span class="tip-key">ğŸ‘Œ æåˆ</span> é”å®šç…§ç‰‡</div>
                <div style="text-align:center; margin-top:12px; margin-bottom:10px; color:#fff; font-weight:bold; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">é”®ç›˜æ§åˆ¶</div>
                <div class="tip-item"><span class="tip-key">1 / T</span> åœ£è¯æ ‘</div>
                <div class="tip-item"><span class="tip-key">2 / S</span> æ˜Ÿæ²³æ•£å¼€</div>
                <div class="tip-item"><span class="tip-key">3 / P</span> é”å®šç…§ç‰‡</div>
                <div class="tip-item"><span class="tip-key">N</span> ä¸‹ä¸€å¼ ç…§ç‰‡</div>
                <div class="tip-item"><span class="tip-key">V</span> æ˜¾/éšæ‘„åƒå¤´</div>
                <div class="tip-item"><span class="tip-key">F</span> å…¨å±åˆ‡æ¢</div>
                <div class="tip-item"><span class="tip-key">H</span> æ˜¾/éšç•Œé¢</div>
                <div class="tip-item"><span class="tip-key">L</span> è§¦å‘ä¹¦ä¿¡</div>
                <div style="text-align:center; margin-top:12px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); color:rgba(0,255,204,0.6); font-size:9px;">
                    power by lovenn
                </div>
            `;
            document.body.appendChild(tips);
        }

        // ========== å‘Šç™½ä¹¦ä¿¡åŠŸèƒ½ ==========

        // é¢„è®¾ä¹¦ä¿¡å†…å®¹ï¼ˆå¯è‡ªå®šä¹‰ä¿®æ”¹ï¼‰
        const PRESET_LETTER = {
            content: `äº²çˆ±çš„è¯ºè¯ºï¼š

åœ¨ç‚¹å¼€è¿™æ£µåœ£è¯æ ‘ä¹‹å‰ï¼Œæˆ‘å·²ç»æƒ³ä½ å¾ˆä¹…äº†ã€‚ã€‚

ä½ ä»¥å‰æ€»è¯´ï¼Œæ²¡æƒ³åˆ°æˆ‘ä»¬ä¼šé‡è§ï¼Œå¥½åƒä¸€åˆ‡éƒ½å¾ˆå·§ï¼Œéƒ½æ˜¯ç¼˜åˆ†ã€‚
ä½†æ„¿æ„å¤šèµ°å‡ æ­¥ã€å¤šèŠ±ä¸€ç‚¹å¿ƒæ€ï¼Œæˆ‘è§‰å¾—é‚£æ˜¯é€‰æ‹©ã€‚

è¿™æ£µæ ‘ä¸ä¼šæ‰å¶å­ï¼Œå°±åƒæˆ‘ä¹Ÿä¸ä¼šçªç„¶ä¸ç†ä½ ï¼Œæƒ…ç»ªå’Œæˆ‘éƒ½å¾ˆç¨³å®šã€‚

æƒ³è¯´ç‚¹åˆ«çš„ï¼Œå¯æ˜¯è¿˜æ˜¯å¤ªæƒ³æ’ä¸€å¥  â€ä½ æ„¿æ„åšæˆ‘å¥³æœ‹å‹å—ï¼Ÿâ€œ 
psï¼šä¸è¯´ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä¼šä¸€ç›´é—®

é—®å®Œä¹Ÿæ²¡å¿ƒæ€å†™åˆ«çš„äº†å“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆã€‚

å¹³å®‰åœ£è¯å¿«ä¹ï¼Œä¹Ÿæ„¿æˆ‘ä»¬ä»¥åä¸€ç›´æœ‰å¾ˆå¤šä¸ªèŠ‚æ—¥ã€‚
psï¼šè‚¯å®šæ˜¯çš„

Merry Christmas, my love!

`,
            createdAt: new Date().toISOString()
        };

        // ä¹¦ä¿¡æ•°æ®å­˜å‚¨
        const LetterStorage = {
            STORAGE_KEY: 'love_letter_data',

            getData() {
                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    return data ? JSON.parse(data) : {
                        letter: null,
                        musicType: 'default',
                        customMusicData: null,
                        customMusicName: null
                    };
                } catch (e) {
                    console.error('è¯»å–ä¹¦ä¿¡æ•°æ®å¤±è´¥:', e);
                    return { letter: null, musicType: 'default', customMusicData: null, customMusicName: null };
                }
            },

            saveData(data) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜ä¹¦ä¿¡æ•°æ®å¤±è´¥:', e);
                    return false;
                }
            },

            saveLetter(content) {
                const data = this.getData();
                data.letter = {
                    content: content,
                    createdAt: new Date().toISOString()
                };
                return this.saveData(data);
            },

            deleteLetter() {
                const data = this.getData();
                data.letter = null;
                return this.saveData(data);
            },

            getLetter() {
                const userLetter = this.getData().letter;
                // å¦‚æœæ²¡æœ‰ç”¨æˆ·ä¸Šä¼ çš„ä¹¦ä¿¡ï¼Œè¿”å›é¢„è®¾ä¹¦ä¿¡
                return userLetter || PRESET_LETTER;
            },

            saveMusicSettings(musicType, customMusicData = null, customMusicName = null) {
                const data = this.getData();
                data.musicType = musicType;
                data.customMusicData = customMusicData;
                data.customMusicName = customMusicName;
                return this.saveData(data);
            },

            getMusicSettings() {
                const data = this.getData();
                return {
                    musicType: data.musicType || 'default',
                    customMusicData: data.customMusicData,
                    customMusicName: data.customMusicName
                };
            },

            // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä¸Šä¼ çš„ä¹¦ä¿¡
            hasUserLetter() {
                return this.getData().letter !== null;
            }
        };

        // ä¹¦ä¿¡åŠŸèƒ½çŠ¶æ€
        let letterState = {
            isEnvelopeShowing: false,
            isLetterDisplaying: false,
            typingInterval: null,
            heartGestureStartTime: null,
            originalMusicSrc: null,
            wasPlaying: false
        };

        // åˆå§‹åŒ–ä¹¦ä¿¡æ¨¡æ€æ¡†
        function setupLetterModal() {
            const letterBtn = document.getElementById('letter-btn');
            const modal = document.getElementById('letter-modal');
            const closeBtn = document.getElementById('letter-modal-close');
            const closeBtn2 = document.getElementById('letter-close-btn');
            const uploadArea = document.getElementById('letter-upload-area');
            const fileInput = document.getElementById('letter-file-input');
            const previewSection = document.getElementById('letter-preview-section');
            const uploadSection = document.getElementById('letter-upload-section');
            const previewText = document.getElementById('letter-preview-text');
            const previewBtn = document.getElementById('preview-letter-btn');
            const deleteBtn = document.getElementById('delete-letter-btn');
            const musicDefault = document.getElementById('music-default');
            const musicCustom = document.getElementById('music-custom');
            const customMusicSection = document.getElementById('letter-custom-music');
            const uploadMusicBtn = document.getElementById('upload-custom-music-btn');
            const customMusicInput = document.getElementById('custom-music-input');
            const customMusicName = document.getElementById('custom-music-name');
            const previewTitle = document.querySelector('.letter-preview-title');

            // åŠ è½½ä¿å­˜çš„æ•°æ®
            function loadSavedData() {
                const letter = LetterStorage.getLetter();
                const hasUserLetter = LetterStorage.hasUserLetter();

                if (letter) {
                    previewSection.style.display = 'block';
                    previewText.textContent = letter.content.substring(0, 200) + (letter.content.length > 200 ? '...' : '');

                    // åŒºåˆ†é¢„è®¾ä¹¦ä¿¡å’Œç”¨æˆ·ä¸Šä¼ çš„ä¹¦ä¿¡
                    if (hasUserLetter) {
                        previewTitle.innerHTML = 'ğŸ“„ å½“å‰ä¹¦ä¿¡ <span style="color: #00ffcc; font-size: 11px;">(è‡ªå®šä¹‰)</span>';
                        deleteBtn.style.display = '';
                    } else {
                        previewTitle.innerHTML = 'ğŸ“„ å½“å‰ä¹¦ä¿¡ <span style="color: #ff6b9d; font-size: 11px;">(é¢„è®¾)</span>';
                        deleteBtn.style.display = 'none';  // é¢„è®¾ä¹¦ä¿¡ä¸æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    }
                } else {
                    previewSection.style.display = 'none';
                }

                const musicSettings = LetterStorage.getMusicSettings();
                if (musicSettings.musicType === 'custom') {
                    musicCustom.checked = true;
                    customMusicSection.style.display = 'block';
                    if (musicSettings.customMusicName) {
                        customMusicName.textContent = musicSettings.customMusicName;
                    }
                } else {
                    musicDefault.checked = true;
                    customMusicSection.style.display = 'none';
                }
            }

            // æ‰“å¼€æ¨¡æ€æ¡†
            letterBtn.addEventListener('click', () => {
                loadSavedData();
                modal.classList.add('show');
            });

            // å…³é—­æ¨¡æ€æ¡†
            const closeModal = () => modal.classList.remove('show');
            closeBtn.addEventListener('click', closeModal);
            closeBtn2.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleLetterFile(file);
            });
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleLetterFile(file);
            });

            // å¤„ç†ä¹¦ä¿¡æ–‡ä»¶
            function handleLetterFile(file) {
                if (!file.name.endsWith('.txt')) {
                    alert('è¯·ä¸Šä¼  .txt æ–‡ä»¶');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    if (LetterStorage.saveLetter(content)) {
                        loadSavedData();
                        alert('ä¹¦ä¿¡ä¸Šä¼ æˆåŠŸï¼');
                    } else {
                        alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                };
                reader.readAsText(file);
            }

            // é¢„è§ˆä¹¦ä¿¡
            previewBtn.addEventListener('click', () => {
                closeModal();
                setTimeout(() => triggerLetterDisplay(), 300);
            });

            // åˆ é™¤ä¹¦ä¿¡
            deleteBtn.addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å°ä¹¦ä¿¡å—ï¼Ÿ')) {
                    LetterStorage.deleteLetter();
                    loadSavedData();
                }
            });

            // éŸ³ä¹é€‰é¡¹åˆ‡æ¢
            musicDefault.addEventListener('change', () => {
                customMusicSection.style.display = 'none';
                LetterStorage.saveMusicSettings('default');
            });
            musicCustom.addEventListener('change', () => {
                customMusicSection.style.display = 'block';
                LetterStorage.saveMusicSettings('custom');
            });

            // è‡ªå®šä¹‰éŸ³ä¹ä¸Šä¼ 
            uploadMusicBtn.addEventListener('click', () => customMusicInput.click());
            customMusicInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        LetterStorage.saveMusicSettings('custom', evt.target.result, file.name);
                        customMusicName.textContent = file.name;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // åˆ›å»ºå¿ƒå½¢ç²’å­ç‰¹æ•ˆ
        function createHeartParticles(x, y) {
            for (let i = 0; i < 8; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart-particle';
                heart.innerHTML = ['ğŸ’•', 'ğŸ’—', 'ğŸ’–', 'â¤ï¸'][Math.floor(Math.random() * 4)];
                heart.style.left = (x + (Math.random() - 0.5) * 60) + 'px';
                heart.style.top = (y + (Math.random() - 0.5) * 60) + 'px';
                heart.style.animationDelay = (Math.random() * 0.3) + 's';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 1500);
            }
        }

        // æ˜¾ç¤ºä¿¡å°åŠ¨ç”»ï¼ˆä»åœ£è¯æ ‘é£å‡ºï¼‰
        function showEnvelope() {
            if (letterState.isEnvelopeShowing || letterState.isLetterDisplaying) return;

            const letter = LetterStorage.getLetter();
            if (!letter) {
                showGestureFeedback('ğŸ’Œ è¯·å…ˆä¸Šä¼ ä¹¦ä¿¡');
                return;
            }

            letterState.isEnvelopeShowing = true;
            const container = document.getElementById('envelope-container');
            const envelope = document.getElementById('envelope');

            // è·å–åœ£è¯æ ‘ä¸­å¿ƒä½ç½®ï¼ˆå±å¹•ä¸­å¿ƒåä¸Šï¼‰
            const startX = window.innerWidth / 2;
            const startY = window.innerHeight * 0.4;
            const endX = window.innerWidth / 2 - 60;
            const endY = window.innerHeight / 2 - 40;

            // è®¾ç½®åˆå§‹ä½ç½®
            envelope.style.left = startX + 'px';
            envelope.style.top = startY + 'px';
            envelope.style.opacity = '0';
            envelope.style.transform = 'scale(0.3) rotate(-20deg)';

            container.classList.add('show');

            // åŠ¨ç”»é£åˆ°ä¸­å¿ƒ
            requestAnimationFrame(() => {
                envelope.style.transition = 'all 2.5s cubic-bezier(0.34, 1.56, 0.64, 1)';  // ä»1.2sæ”¹ä¸º2.5sï¼Œé€Ÿåº¦å‡æ…¢
                envelope.style.left = endX + 'px';
                envelope.style.top = endY + 'px';
                envelope.style.opacity = '1';
                envelope.style.transform = 'scale(1) rotate(0deg)';
            });

            // åˆ›å»ºå¿ƒå½¢ç²’å­
            createHeartParticles(startX, startY);

            // ç‚¹å‡»ä¿¡å°å±•å¼€ä¹¦ä¿¡
            envelope.onclick = () => {
                container.classList.remove('show');
                letterState.isEnvelopeShowing = false;
                setTimeout(() => showLetterDisplay(), 600);  // ä»300msæ”¹ä¸º600msï¼Œå»¶è¿ŸåŠ é•¿
            };
        }

        // æ˜¾ç¤ºä¹¦ä¿¡ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
        function showLetterDisplay() {
            if (letterState.isLetterDisplaying) return;

            const letter = LetterStorage.getLetter();
            if (!letter) return;

            letterState.isLetterDisplaying = true;

            const display = document.getElementById('letter-display');
            const contentEl = document.getElementById('letter-content');
            const dateEl = document.getElementById('letter-date');

            // è®¾ç½®æ—¥æœŸ
            const date = new Date(letter.createdAt);
            dateEl.textContent = date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

            // æ¸…ç©ºå†…å®¹
            contentEl.innerHTML = '<span class="typing-cursor"></span>';

            display.classList.add('show');

            // åˆ‡æ¢åˆ°æµªæ¼«éŸ³ä¹
            switchToRomanticMusic();

            // æ‰“å­—æœºæ•ˆæœ
            const text = letter.content;
            let index = 0;
            letterState.typingInterval = setInterval(() => {
                if (index < text.length) {
                    const char = text[index];
                    contentEl.innerHTML = text.substring(0, index + 1) + '<span class="typing-cursor"></span>';
                    index++;
                } else {
                    clearInterval(letterState.typingInterval);
                    contentEl.innerHTML = text; // ç§»é™¤å…‰æ ‡
                }
            }, 100); // æ‰“å­—é€Ÿåº¦ï¼ˆä»50msæ”¹ä¸º100msï¼Œé€Ÿåº¦å‡æ…¢ä¸€åŠï¼‰
        }

        // å…³é—­ä¹¦ä¿¡å±•ç¤º
        function closeLetterDisplay() {
            const display = document.getElementById('letter-display');
            display.classList.remove('show');
            letterState.isLetterDisplaying = false;

            if (letterState.typingInterval) {
                clearInterval(letterState.typingInterval);
                letterState.typingInterval = null;
            }

            // æ¢å¤åŸéŸ³ä¹
            restoreOriginalMusic();
        }

        // åˆ‡æ¢åˆ°æµªæ¼«éŸ³ä¹
        function switchToRomanticMusic() {
            const bgMusic = document.getElementById('bg-music');
            const romanticMusic = document.getElementById('romantic-music');

            // ä¿å­˜å½“å‰çŠ¶æ€
            letterState.originalMusicSrc = bgMusic.src;
            letterState.wasPlaying = !bgMusic.paused;

            // æš‚åœåŸéŸ³ä¹
            bgMusic.pause();

            // è®¾ç½®æµªæ¼«éŸ³ä¹
            const musicSettings = LetterStorage.getMusicSettings();
            if (musicSettings.musicType === 'custom' && musicSettings.customMusicData) {
                romanticMusic.src = musicSettings.customMusicData;
            } else {
                // ä½¿ç”¨é¢„è®¾æµªæ¼«éŸ³ä¹
                romanticMusic.src = PRESET_MUSIC.romantic;
            }

            // æ’­æ”¾æµªæ¼«éŸ³ä¹
            romanticMusic.volume = bgMusic.volume || 0.5;
            romanticMusic.play().catch(e => console.log('éŸ³ä¹æ’­æ”¾å¤±è´¥:', e));
        }

        // æ¢å¤åŸéŸ³ä¹
        function restoreOriginalMusic() {
            const bgMusic = document.getElementById('bg-music');
            const romanticMusic = document.getElementById('romantic-music');

            romanticMusic.pause();
            romanticMusic.currentTime = 0;

            if (letterState.wasPlaying) {
                bgMusic.play().catch(e => console.log('æ¢å¤éŸ³ä¹å¤±è´¥:', e));
            }
        }

        // æ˜¾ç¤ºæ‰‹åŠ¿åé¦ˆ
        function showGestureFeedback(text) {
            const feedback = document.getElementById('gesture-feedback');
            feedback.textContent = text;
            feedback.classList.add('show');
            setTimeout(() => feedback.classList.remove('show'), 2000);
        }

        // è§¦å‘ä¹¦ä¿¡å±•ç¤ºï¼ˆå¯ç”±æ‰‹åŠ¿æˆ–æŒ‰é’®è§¦å‘ï¼‰
        function triggerLetterDisplay() {
            const letter = LetterStorage.getLetter();
            if (!letter) {
                showGestureFeedback('ğŸ’Œ è¯·å…ˆä¸Šä¼ ä¹¦ä¿¡');
                return;
            }
            showEnvelope();
        }

        // è®¾ç½®ä¹¦ä¿¡å±•ç¤ºå…³é—­äº‹ä»¶
        function setupLetterDisplayEvents() {
            const display = document.getElementById('letter-display');
            const closeBtn = document.getElementById('letter-display-close');
            const paper = display.querySelector('.letter-paper');

            closeBtn.addEventListener('click', closeLetterDisplay);
            display.addEventListener('click', (e) => {
                if (e.target === display) closeLetterDisplay();
            });
        }

        // ç‚¹èµæ‰‹åŠ¿æ£€æµ‹å‡½æ•°ï¼ˆç«–èµ·å¤§æ‹‡æŒ‡ï¼‰
        function detectHeartGesture(landmarks) {
            if (!landmarks || landmarks.length === 0) return false;

            const hand = landmarks[0];

            // å…³é”®ç‚¹ç´¢å¼•
            const thumbTip = hand[4];   // æ‹‡æŒ‡å°–
            const thumbIp = hand[3];    // æ‹‡æŒ‡æŒ‡é—´å…³èŠ‚
            const thumbMcp = hand[2];   // æ‹‡æŒ‡æŒæŒ‡å…³èŠ‚
            const indexTip = hand[8];   // é£ŸæŒ‡å°–
            const indexPip = hand[6];   // é£ŸæŒ‡è¿‘ç«¯æŒ‡é—´å…³èŠ‚
            const indexMcp = hand[5];   // é£ŸæŒ‡æŒæŒ‡å…³èŠ‚
            const middleTip = hand[12]; // ä¸­æŒ‡å°–
            const middlePip = hand[10]; // ä¸­æŒ‡è¿‘ç«¯æŒ‡é—´å…³èŠ‚
            const middleMcp = hand[9];  // ä¸­æŒ‡æŒæŒ‡å…³èŠ‚
            const ringTip = hand[16];   // æ— åæŒ‡å°–
            const ringPip = hand[14];   // æ— åæŒ‡è¿‘ç«¯æŒ‡é—´å…³èŠ‚
            const ringMcp = hand[13];   // æ— åæŒ‡æŒæŒ‡å…³èŠ‚
            const pinkyTip = hand[20];  // å°æŒ‡å°–
            const pinkyPip = hand[18];  // å°æŒ‡è¿‘ç«¯æŒ‡é—´å…³èŠ‚
            const pinkyMcp = hand[17];  // å°æŒ‡æŒæŒ‡å…³èŠ‚
            const wrist = hand[0];      // æ‰‹è…•

            // æ¡ä»¶1: å¤§æ‹‡æŒ‡ç«–èµ·ï¼ˆæ‹‡æŒ‡å°–yåæ ‡æ˜æ˜¾å°äºæ‹‡æŒ‡æ ¹éƒ¨yåæ ‡ï¼‰
            const isThumbUp = thumbTip.y < thumbMcp.y - 0.05;

            // æ¡ä»¶2: å¤§æ‹‡æŒ‡ä¼¸ç›´ï¼ˆæ‹‡æŒ‡å°–åˆ°æ‹‡æŒ‡æ ¹éƒ¨çš„è·ç¦»è¶³å¤Ÿé•¿ï¼‰
            const thumbLength = Math.hypot(thumbTip.x - thumbMcp.x, thumbTip.y - thumbMcp.y);
            const isThumbExtended = thumbLength > 0.1;

            // æ¡ä»¶3: é£ŸæŒ‡å¼¯æ›²æ¡æ‹³ï¼ˆæŒ‡å°–yåæ ‡å¤§äºæŒæŒ‡å…³èŠ‚yåæ ‡ï¼‰
            const isIndexBent = indexTip.y > indexMcp.y;

            // æ¡ä»¶4: ä¸­æŒ‡å¼¯æ›²æ¡æ‹³
            const isMiddleBent = middleTip.y > middleMcp.y;

            // æ¡ä»¶5: æ— åæŒ‡å¼¯æ›²æ¡æ‹³
            const isRingBent = ringTip.y > ringMcp.y;

            // æ¡ä»¶6: å°æŒ‡å¼¯æ›²æ¡æ‹³
            const isPinkyBent = pinkyTip.y > pinkyMcp.y;

            // æ¡ä»¶7: å¤§æ‹‡æŒ‡ä¸é£ŸæŒ‡ä¿æŒä¸€å®šè·ç¦»ï¼ˆåŒºåˆ†ç‚¹èµå’Œæ¡æ‹³ï¼‰
            const thumbIndexDist = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
            const isThumbAwayFromIndex = thumbIndexDist > 0.1;

            const isThumbsUp = isThumbUp && isThumbExtended && isIndexBent && isMiddleBent && isRingBent && isPinkyBent && isThumbAwayFromIndex;

            return isThumbsUp;
        }

        // å¤„ç†ç‚¹èµæ‰‹åŠ¿ï¼ˆéœ€è¦æŒç»­ä¸€æ®µæ—¶é—´æ‰è§¦å‘ï¼‰
        function handleHeartGesture(isDetected) {
            const feedback = document.getElementById('gesture-feedback');

            if (isDetected) {
                if (!letterState.heartGestureStartTime) {
                    letterState.heartGestureStartTime = Date.now();
                    feedback.textContent = 'ğŸ‘ ç‚¹èµæ£€æµ‹ä¸­...';
                    feedback.classList.add('show');
                }

                const elapsed = Date.now() - letterState.heartGestureStartTime;
                const progress = Math.min(elapsed / 2000, 1); // 2ç§’è§¦å‘

                if (elapsed >= 2000) {
                    // è§¦å‘æˆåŠŸ
                    letterState.heartGestureStartTime = null;
                    feedback.classList.remove('show');

                    // é˜²æ­¢é‡å¤è§¦å‘
                    if (!letterState.isEnvelopeShowing && !letterState.isLetterDisplaying) {
                        createHeartParticles(window.innerWidth - 100, window.innerHeight - 100);
                        triggerLetterDisplay();
                    }
                } else {
                    feedback.textContent = `ğŸ‘ ç‚¹èµä¸­... ${Math.round(progress * 100)}%`;
                }
            } else {
                if (letterState.heartGestureStartTime) {
                    letterState.heartGestureStartTime = null;
                    feedback.classList.remove('show');
                }
            }
        }

        // åˆå§‹åŒ–é¢„è®¾éŸ³ä¹
        function initPresetMusic() {
            const bgMusic = document.getElementById('bg-music');
            const romanticMusic = document.getElementById('romantic-music');

            // è®¾ç½®èƒŒæ™¯éŸ³ä¹
            if (bgMusic) {
                bgMusic.src = PRESET_MUSIC.background;
                // å°è¯•è‡ªåŠ¨æ’­æ”¾
                bgMusic.play().catch(err => {
                    console.log('è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’:', err);
                    // æ·»åŠ ä¸€æ¬¡æ€§ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œåœ¨ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»æ—¶æ’­æ”¾
                    const playOnInteraction = () => {
                        bgMusic.play().catch(e => console.log('æ’­æ”¾å¤±è´¥:', e));
                        document.removeEventListener('click', playOnInteraction);
                        document.removeEventListener('touchstart', playOnInteraction);
                    };
                    document.addEventListener('click', playOnInteraction);
                    document.addEventListener('touchstart', playOnInteraction);
                });
            }

            // è®¾ç½®æµªæ¼«éŸ³ä¹
            if (romanticMusic) {
                romanticMusic.src = PRESET_MUSIC.romantic;
            }
        }
        (function(){'use strict';var _0xb7ed;const _0xc2bg={'\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u006E\u0074\u0065\u0078\u0074\u004D\u0065\u006E\u0075':!![],"disableDevToolsShortcuts":!![],"detectDevTools":!![],'\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064':160,"detectInterval":500,"disableSelection":!![],'\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u0070\u0079':!![],'\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E':'blank','\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064':null};_0xb7ed="ecmjon".split("").reverse().join("");function _0xd35bcc(options={}){Object['\u0061\u0073\u0073\u0069\u0067\u006E'](_0xc2bg,options);if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u006E\u0074\u0065\u0078\u0074\u004D\u0065\u006E\u0075']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u0063\u006F\u006E\u0074\u0065\u0078\u0074\u006D\u0065\u006E\u0075",e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0053\u0068\u006F\u0072\u0074\u0063\u0075\u0074\u0073']){_0x6fg55b();}if(_0xc2bg['\u0064\u0065\u0074\u0065\u0063\u0074\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073']){_0xf39b();}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0053\u0065\u006C\u0065\u0063\u0074\u0069\u006F\u006E']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u0073\u0065\u006C\u0065\u0063\u0074\u0073\u0074\u0061\u0072\u0074",e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());_0xb34aaa();}if(_0xc2bg['\u0064\u0069\u0073\u0061\u0062\u006C\u0065\u0043\u006F\u0070\u0079']){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("ypoc".split("").reverse().join(""),e=>e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']());}}function _0x6fg55b(){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("\u006B\u0065\u0079\u0064\u006F\u0077\u006E",e=>{if(e['\u006B\u0065\u0079']==="21F".split("").reverse().join("")){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0049"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u004A"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0075"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u0063\u0074\u0072\u006C\u004B\u0065\u0079']&&e['\u0073\u0068\u0069\u0066\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0043"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0069"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u006A"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u0061\u006C\u0074\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0063"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}if(e['\u006D\u0065\u0074\u0061\u004B\u0065\u0079']&&e['\u006B\u0065\u0079']==="\u0075"){e['\u0070\u0072\u0065\u0076\u0065\u006E\u0074\u0044\u0065\u0066\u0061\u0075\u006C\u0074']();return false;}});}function _0xf39b(){const _0xd86ab={"open":false};setInterval(()=>{if(window['\u006F\u0075\u0074\u0065\u0072\u0057\u0069\u0064\u0074\u0068']-window['\u0069\u006E\u006E\u0065\u0072\u0057\u0069\u0064\u0074\u0068']>_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064']||window['\u006F\u0075\u0074\u0065\u0072\u0048\u0065\u0069\u0067\u0068\u0074']-window['\u0069\u006E\u006E\u0065\u0072\u0048\u0065\u0069\u0067\u0068\u0074']>_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0054\u0068\u0072\u0065\u0073\u0068\u006F\u006C\u0064']){if(!_0xd86ab['\u006F\u0070\u0065\u006E']){_0xd86ab['\u006F\u0070\u0065\u006E']=!![];_0x_0xc11();}}},_0xc2bg['\u0064\u0065\u0074\u0065\u0063\u0074\u0049\u006E\u0074\u0065\u0072\u0076\u0061\u006C']);}function _0x_0xc11(){if(_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E']==="motsuc".split("").reverse().join("")&&typeof _0xc2bg['\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064']==="noitcnuf".split("").reverse().join("")){_0xc2bg['\u006F\u006E\u0044\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0044\u0065\u0074\u0065\u0063\u0074\u0065\u0064']();}else if(_0xc2bg['\u0064\u0065\u0076\u0054\u006F\u006F\u006C\u0073\u0041\u0063\u0074\u0069\u006F\u006E']==="\u0063\u006C\u006F\u0073\u0065"){window['\u0063\u006C\u006F\u0073\u0065']();setTimeout(()=>{document['\u0062\u006F\u0064\u0079']['\u0069\u006E\u006E\u0065\u0072\u0048\u0054\u004D\u004C']='';window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0068\u0072\u0065\u0066']="\u0061\u0062\u006F\u0075\u0074\u003A\u0062\u006C\u0061\u006E\u006B";},428544^428644);}else{document['\u0062\u006F\u0064\u0079']['\u0069\u006E\u006E\u0065\u0072\u0048\u0054\u004D\u004C']='';window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0068\u0072\u0065\u0066']="\u0061\u0062\u006F\u0075\u0074\u003A\u0062\u006C\u0061\u006E\u006B";}}function _0xb34aaa(){var _0x98a9f=(838550^838558)+(650674^650673);const _0xcg5fb=document['\u0063\u0072\u0065\u0061\u0074\u0065\u0045\u006C\u0065\u006D\u0065\u006E\u0074']("\u0073\u0074\u0079\u006C\u0065");_0x98a9f=171847^171844;_0xcg5fb['\u0074\u0065\u0078\u0074\u0043\u006F\u006E\u0074\u0065\u006E\u0074']=`
            * {
                user-select: none !important;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
            }
        `;document['\u0068\u0065\u0061\u0064']['\u0061\u0070\u0070\u0065\u006E\u0064\u0043\u0068\u0069\u006C\u0064'](_0xcg5fb);}function _0x3435dc(){console['\u0077\u0061\u0072\u006E']("\u3002\u7528\u4F7F\u8BD5\u8C03\u53D1\u5F00\u4F9B\u4EC5\u80FD\u529F\u6B64\uFF01\u9664\u79FB\u88AB\u5DF2\u62A4\u4FDD\u7801\u6E90".split("").reverse().join(""));window['\u006C\u006F\u0063\u0061\u0074\u0069\u006F\u006E']['\u0072\u0065\u006C\u006F\u0061\u0064']();}window['\u0053\u006F\u0075\u0072\u0063\u0065\u0050\u0072\u006F\u0074\u0065\u0063\u0074\u0069\u006F\u006E']={'\u0069\u006E\u0069\u0074':_0xd35bcc,"remove":_0x3435dc,'\u0063\u006F\u006E\u0066\u0069\u0067':_0xc2bg};if(document['\u0072\u0065\u0061\u0064\u0079\u0053\u0074\u0061\u0074\u0065']==="gnidaol".split("").reverse().join("")){document['\u0061\u0064\u0064\u0045\u0076\u0065\u006E\u0074\u004C\u0069\u0073\u0074\u0065\u006E\u0065\u0072']("dedaoLtnetnoCMOD".split("").reverse().join(""),()=>_0xd35bcc());}else{_0xd35bcc();}})();
        
        function animate(){requestAnimationFrame(animate);var _0xbfb=(986210^986214)+(456706^456707);const _0xedb41b=clock['\u0067\u0065\u0074\u0044\u0065\u006C\u0074\u0061']();_0xbfb="deapdf".split("").reverse().join("");if(STATE['\u006D\u006F\u0064\u0065']==="\u0046\u004F\u0043\u0055\u0053"&&STATE['\u0066\u006F\u0063\u0075\u0073\u0054\u0061\u0072\u0067\u0065\u0074']){bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068']=THREE['\u004D\u0061\u0074\u0068\u0055\u0074\u0069\u006C\u0073']['\u006C\u0065\u0072\u0070'](bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068'],0.6,(503220^503217)*_0xedb41b);var _0x079f=(585674^585666)+(446849^446854);const _0xa3219a=new THREE['\u0056\u0065\u0063\u0074\u006F\u0072\u0033']();_0x079f=(981045^981042)+(384343^384342);STATE['\u0066\u006F\u0063\u0075\u0073\u0054\u0061\u0072\u0067\u0065\u0074']['\u0067\u0065\u0074\u0057\u006F\u0072\u006C\u0064\u0050\u006F\u0073\u0069\u0074\u0069\u006F\u006E'](_0xa3219a);var _0xa689cd;const _0x_0x69a=_0xa3219a['\u0063\u006C\u006F\u006E\u0065']()['\u006E\u006F\u0072\u006D\u0061\u006C\u0069\u007A\u0065']();_0xa689cd='\u0070\u0065\u006F\u0066\u0065\u006B';STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073']['\u0063\u006F\u0070\u0079'](_0xa3219a)['\u0061\u0064\u0064'](_0x_0x69a['\u006D\u0075\u006C\u0074\u0069\u0070\u006C\u0079\u0053\u0063\u0061\u006C\u0061\u0072'](712522^712524));STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u0063\u006F\u0070\u0079'](_0xa3219a);}else{bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068']=THREE['\u004D\u0061\u0074\u0068\u0055\u0074\u0069\u006C\u0073']['\u006C\u0065\u0072\u0070'](bloomPass['\u0073\u0074\u0072\u0065\u006E\u0067\u0074\u0068'],1.5,(446980^446982)*_0xedb41b);let _0x13986d=STATE['\u006D\u006F\u0064\u0065']==="RETTACS".split("").reverse().join("")?924437^924479:808169^808155;STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073']['\u0073\u0065\u0074'](777658^777658,820825^820827,_0x13986d);STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u0073\u0065\u0074'](138865^138865,712947^712947,489012^489012);}camera['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u006C\u0065\u0072\u0070'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u0050\u006F\u0073'],(853060^853061)*_0xedb41b);STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u004C\u006F\u006F\u006B\u0041\u0074']['\u006C\u0065\u0072\u0070'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0074\u0061\u0072\u0067\u0065\u0074\u004C\u006F\u006F\u006B\u0041\u0074'],1.5*_0xedb41b);camera['\u006C\u006F\u006F\u006B\u0041\u0074'](STATE['\u0063\u0061\u006D\u0065\u0072\u0061']['\u0063\u0075\u0072\u0072\u0065\u006E\u0074\u004C\u006F\u006F\u006B\u0041\u0074']);if(STATE['\u006D\u006F\u0064\u0065']!=="SUCOF".split("").reverse().join("")){if(STATE['\u006D\u006F\u0064\u0065']==="\u0053\u0043\u0041\u0054\u0054\u0045\u0052"&&STATE['\u0068\u0061\u006E\u0064']['\u0064\u0065\u0074\u0065\u0063\u0074\u0065\u0064']){STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']+=(STATE['\u0068\u0061\u006E\u0064']['\u0079']*0.8-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'])*(399880^399883)*_0xedb41b;STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=(STATE['\u0068\u0061\u006E\u0064']['\u0078']*2.5-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079'])*(534618^534617)*_0xedb41b;}else{STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=(STATE['\u006D\u006F\u0064\u0065']==="EERT".split("").reverse().join("")?0.3:0.05)*_0xedb41b;STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']+=((459738^459738)-STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'])*(583397^583399)*_0xedb41b;}mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']=STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079'];mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078']=STATE['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0078'];}else{mainGroup['\u0072\u006F\u0074\u0061\u0074\u0069\u006F\u006E']['\u0079']+=0.05*_0xedb41b;}if(snowSystem){const _0x2_0x5ca=snowSystem['\u0067\u0065\u006F\u006D\u0065\u0074\u0072\u0079']['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u0061\u0072\u0072\u0061\u0079'];for(let i=287964^287965;i<_0x2_0x5ca['\u006C\u0065\u006E\u0067\u0074\u0068'];i+=354436^354439){_0x2_0x5ca[i]-=0.08;if(_0x2_0x5ca[i]<-(893042^893036))_0x2_0x5ca[i]=692424^692448;}snowSystem['\u0067\u0065\u006F\u006D\u0065\u0074\u0072\u0079']['\u0061\u0074\u0074\u0072\u0069\u0062\u0075\u0074\u0065\u0073']['\u0070\u006F\u0073\u0069\u0074\u0069\u006F\u006E']['\u006E\u0065\u0065\u0064\u0073\u0055\u0070\u0064\u0061\u0074\u0065']=!![];}particleSystem['\u0066\u006F\u0072\u0045\u0061\u0063\u0068'](p=>p['\u0075\u0070\u0064\u0061\u0074\u0065'](_0xedb41b,STATE['\u006D\u006F\u0064\u0065']));composer['\u0072\u0065\u006E\u0064\u0065\u0072']();}async function init(){await PhotoCache['\u0069\u006E\u0069\u0074']();initPresetMusic();initThree();createMaterials();setupLights();createParticles();createChristmasDecorations();createSnow();await restorePhotosFromCache();await loadPresetPhotos();setupPostProcessing();setupEvents();createTips();setupLetterModal();setupLetterDisplayEvents();await setupCameraPermissionModal();animate();}init();
    </script>

</body>


</html>

